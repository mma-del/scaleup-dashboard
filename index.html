<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaleup Finance - e-conomic Dashboard</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A////AP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///wD///8A3a4hAtuqGQLdriEA3a4hAN2uIQDdriEA3a4hAN2uIQDdriEA////AP///wAAAAAAAAAAAAAAAAD///8A3a4hAtuqGQrbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQD///8AAAAAAAAAAAD///8A3a4hAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkA////AAAAAAD///8A3a4hAN2uIQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC3a4hAP///wD///8A////AN2uIQDdriEC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wDdriEA3a4hAtuqGQLbqhkC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wD///8A////AN2uIQDdriEC26oZAtuqGQLbqhkC26oZAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wD///8A////AP///wDdriEA3a4hAtuqGQLbqhkC26oZAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wD///8A////AP///wD///8A////AN2uIQDdriEC26oZAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wD///8A////AP///wD///8A////AP///wDdriEA3a4hAtuqGQLbqhkC3a4hAN2uIQD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AN2uIQDdriEC3a4hAN2uIQD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wDdriEA3a4hAN2uIQD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AADwDwAAwAcAAMADAACAAQAAgAEAAAAAAAAAAAAAAAAAAAABAACAAwAAwAcAAOAPAAD//wAA//8AAA==">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 74, 71, 0.3);
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .auth-toggle a {
            color: #3a4a47;
            text-decoration: none;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* User Info Bar */
        .user-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            font-weight: 600;
            color: #3a4a47;
        }
        
        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .role-super-admin { background: #ff4444; color: white; }
        .role-admin { background: #ff8800; color: white; }
        .role-project-manager { background: #ffdd00; color: #333; }
        .role-team-lead { background: #44ff44; color: #333; }
        .role-user { background: #e9ecef; color: #495057; }
        
        /* CENTERED HEADER */
        .header { 
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
            color: white; 
            padding: 50px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 30px;
        }
        
        .scaleup-logo {
            width: 100px; 
            height: 100px; 
            background: #ffffff; 
            border-radius: 15px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .scaleup-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-fallback {
            color: #3a4a47; 
            font-size: 36px; 
            font-weight: 800;
        }
        
        .company-name {
            font-size: 4em;
            font-weight: 700;
            color: white;
        }
        
        .header-description {
            font-size: 1.3em;
            opacity: 0.9;
            text-align: center;
        }
        
        /* Project Controls */
        .project-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            min-width: 250px;
        }
        
        .shared-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .nav-tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .nav-tab { flex: 1; padding: 15px 25px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; }
        .nav-tab.active { background: linear-gradient(135deg, #3a4a47, #2d3a36); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .setup-form { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-family: 'Segoe UI', sans-serif; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #3a4a47; color: white; }
        .btn-primary:hover { background: #2d3a36; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-small { padding: 6px 12px !important; font-size: 0.85em !important; }
        
        /* Team Members Styles */
        .team-section {
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
            border: 2px solid #3a4a47;
        }
        
        .team-section h3 {
            color: #3a4a47; 
            margin-bottom: 15px;
        }
        
        .team-input-row {
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px;
            align-items: center;
        }
        
        .team-input {
            flex: 1; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            font-size: 1em;
        }
        
        .team-select {
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            background: white;
            min-width: 150px;
        }
        
        .team-member-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px; 
            background: white; 
            border-radius: 6px; 
            margin: 8px 0; 
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .team-member-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .team-member-info {
            display: flex;
            flex-direction: column;
        }
        
        .team-member-name {
            font-weight: 600;
            color: #3a4a47;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .team-member-company {
            font-size: 0.9em;
            color: #666;
            margin-left: 28px;
        }
        
        .btn-small {
            padding: 6px 12px; 
            font-size: 0.85em;
        }
        
        /* Dashboard styles */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        
        .kpi-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(58, 74, 71, 0.15); 
            text-align: center; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(58, 74, 71, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(58, 74, 71, 0.2);
        }
        
        .kpi-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 8px 16px rgba(58, 74, 71, 0.3);
        }
        
        .kpi-value { 
            font-size: 3.5em; 
            font-weight: 800; 
            margin: 20px 0 10px; 
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .kpi-label { 
            color: #666; 
            font-size: 1.1em; 
            font-weight: 600;
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 15px;
        }
        
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 20px 0 10px;
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3a4a47, #2d3a36, #3a4a47); 
            border-radius: 10px; 
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .kpi-subtitle {
            font-size: 0.9em;
            color: #3a4a47;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .dashboard-intro {
            background: linear-gradient(135deg, rgba(58, 74, 71, 0.05) 0%, rgba(45, 58, 54, 0.05) 100%);
            border: 1px solid rgba(58, 74, 71, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-intro h2 {
            color: #3a4a47;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .dashboard-intro p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; }
        
        .table-header { background: #3a4a47; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .client-info { font-size: 1.1em; opacity: 0.9; }
        
        .status-select { padding: 8px 12px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; }
        .status-completed { background: #28a745; color: white; }
        .status-in-progress { background: #3a4a47; color: white; }
        .status-not-started { background: #e9ecef; color: #495057; }
        
        .warning-message { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        
        /* Admin Panel Styles */
        .admin-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .admin-section {
            margin-bottom: 30px;
        }
        
        .admin-section h3 {
            color: #3a4a47;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .user-list {
            display: grid;
            gap: 10px;
        }
        
        .user-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .user-row:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .user-email {
            font-weight: 600;
            color: #3a4a47;
        }
        
        .role-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #3a4a47;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-body input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <h1>Scaleup Finance</h1>
                <p>e-conomic Dimensions Dashboard</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2 style="margin-bottom: 20px;">Log ind</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button onclick="handleLogin()">Log ind</button>
                <div class="auth-toggle">
                    Ny bruger? <a href="#" onclick="showSignup(); return false;">Opret konto</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <h2 style="margin-bottom: 20px;">Opret konto</h2>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6 tegn)" required>
                <input type="text" id="company-name" placeholder="Firmanavn" required>
                <button onclick="handleSignup()">Opret konto</button>
                <div class="auth-toggle">
                    Har du allerede en konto? <a href="#" onclick="showLogin(); return false;">Log ind</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Project Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîó Del Projekt</h2>
                <span class="close" onclick="closeShareModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Indtast email p√• den bruger du vil dele projektet med:</p>
                <input type="email" id="share-email" placeholder="kollega@firma.dk">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeShareModal()">Annuller</button>
                <button class="btn btn-primary" onclick="confirmShare()">Del Projekt</button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until logged in) -->
    <div id="main-dashboard" class="container" style="display: none;">
        
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info">
                <span>Logget ind som:</span>
                <span class="user-email" id="current-user-email">-</span>
                <span class="role-badge" id="current-user-role">User</span>
            </div>
            <div>
                <button class="btn btn-warning" id="admin-btn" onclick="switchTab('admin')" style="display: none;">üëë Admin Panel</button>
                <button class="btn btn-danger" onclick="handleLogout()">Log ud</button>
            </div>
        </div>
        
        <!-- CENTERED HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="scaleup-logo">
                    <img id="header-logo" style="display: none;" alt="Company Logo">
                    <div class="logo-fallback" id="logo-fallback">SF</div>
                </div>
                <div class="company-name">Scaleup Finance</div>
            </div>
            <div class="header-description">e-conomic Dimensions Implementation Dashboard</div>
        </div>

        <!-- Project Controls -->
        <div class="project-controls">
            <div class="project-info">
                <label style="font-weight: 600; color: #495057;">Current Project:</label>
                <select id="project-select" class="project-select" onchange="loadProject(this.value)">
                    <option value="">V√¶lg eller opret et projekt...</option>
                </select>
                <span id="connection-status" class="status-badge status-online" style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">Online</span>
            </div>
            <div>
                <button class="btn btn-info" onclick="shareProject()">üîó Del Projekt</button>
                <button class="btn btn-success" onclick="createNewProject()">üîÑ Nyt Projekt</button>
                <button class="btn btn-secondary" onclick="exportProject()">üíæ Export</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">üîß Client Setup</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('project')">üìã Project Plan</button>
            <button class="nav-tab" id="admin-tab" onclick="switchTab('admin')" style="display: none;">üëë Admin Panel</button>
        </div>

        <!-- Client Setup Tab -->
        <div id="setup-tab" class="tab-content active">
            <div class="setup-form">
                <h2>Client Information Setup</h2>
                <p style="margin-bottom: 25px; color: #666;">Configure client details for this project.</p>
                
                <div class="form-group">
                    <label>Client Company Name *</label>
                    <input type="text" id="client-name" placeholder="e.g., ABC Corporation" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Scaleup Finance Project Manager *</label>
                    <input type="text" id="scaleup-pm" placeholder="e.g., Lars Jensen" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Client Project Manager</label>
                    <input type="text" id="client-pm" placeholder="e.g., John Smith (CFO)" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Upload Company Logo</label>
                    <div style="border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa;">
                        <input type="file" id="logo-upload" accept="image/*" style="margin-bottom: 10px;" onchange="handleLogoUpload(event)">
                        <p style="color: #666; font-size: 0.9em; margin: 0;">V√¶lg en logofil (PNG, JPG, GIF)</p>
                        <div id="upload-preview" style="margin-top: 15px; display: none;">
                            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Team Members Section FIXED -->
                <div class="team-section">
                    <h3>üë• Team Members</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Tilf√∏j team medlemmer som kan tildeles specifikke opgaver.</p>
                    
                    <div class="team-input-row">
                        <input type="text" id="new-member-name" class="team-input" placeholder="Indtast team medlems navn..." maxlength="50">
                        <select id="new-member-company" class="team-select">
                            <option value="Scaleup Finance">Scaleup Finance</option>
                            <option value="Client" id="client-company-option">Client</option>
                        </select>
                        <button type="button" class="btn btn-success btn-small" onclick="addTeamMember()">‚ûï Tilf√∏j</button>
                    </div>

                    <div id="team-members-list">
                        <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">Ingen team medlemmer tilf√∏jet endnu.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Project Notes (Optional)</label>
                    <textarea id="project-notes" rows="3" placeholder="Any specific notes about this implementation..." onchange="saveToSupabase()"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSetup()">üíæ Save Client Setup</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div id="dashboard-warning" class="warning-message">
                ‚ö†Ô∏è Please select a project and complete the Client Setup first to view the dashboard.
            </div>
            
            <div id="dashboard-content" style="display: none;">
                <div class="dashboard-intro">
                    <h2>üìä Project Overview</h2>
                    <p>Monitor your e-conomic dimensions implementation progress.</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-label">Overall Progress</div>
                        <div class="kpi-value" id="overall-progress">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overall-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="kpi-subtitle">Implementation Status</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-label">Completed Tasks</div>
                        <div class="kpi-value" id="completed-tasks">0</div>
                        <div class="kpi-subtitle">of <span id="total-tasks">0</span> total tasks</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">üîÑ</div>
                        <div class="kpi-label">Active Tasks</div>
                        <div class="kpi-value" id="ongoing-tasks">0</div>
                        <div class="kpi-subtitle">currently in progress</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">üéØ</div>
                        <div class="kpi-label">Next Milestone</div>
                        <div class="kpi-value" style="font-size: 1.8em; line-height: 1.2;" id="next-milestone">Requirements Analysis</div>
                        <div class="kpi-subtitle">Phase 1 - Analysis</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Plan Tab -->
        <div id="project-tab" class="tab-content">
            <div id="project-warning" class="warning-message">
                ‚ö†Ô∏è Please select a project and complete the Client Setup first to access the project plan.
            </div>
            
            <div id="project-content" style="display: none;">
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <div class="table-header">
                        <h2>üìã Detailed Project Plan</h2>
                        <div class="client-info" id="client-display">No project selected</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 350px">Task</th>
                                <th style="width: 150px">Status</th>
                                <th style="width: 200px">Responsible</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="project-body">
                            <tr>
                                <td colspan="4" class="loading">Select a project to view tasks...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin-tab" class="tab-content">
            <div class="admin-panel">
                <h2>üëë Admin Panel</h2>
                <p style="margin-bottom: 30px; color: #666;">Administrer brugere og roller p√• tv√¶rs af systemet.</p>
                
                <div class="admin-section">
                    <h3>üë• Bruger Administration</h3>
                    <div id="user-list" class="user-list">
                        <div class="loading">Indl√¶ser brugere...</div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3>üìä System Statistik</h3>
                    <div class="dashboard-grid">
                        <div class="kpi-card">
                            <div class="kpi-value" id="total-users">0</div>
                            <div class="kpi-label">Total Brugere</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="total-projects">0</div>
                            <div class="kpi-label">Total Projekter</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="active-projects">0</div>
                            <div class="kpi-label">Aktive Projekter</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // TILPAS DISSE V√ÜRDIER MED DINE SUPABASE CREDENTIALS
        const supabaseUrl = 'https://swlnojbzlfosjdtqswjd.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bG5vamJ6bGZvc2pkdHFzd2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDUzNzIsImV4cCI6MjA3MjkyMTM3Mn0.weAmKGGMeUaerNwyAoz6dpFufK0Fz1YbrdaUzsKiYk8';
        
        // ADMIN EMAILS - TILF√òJ DINE ADMIN EMAILS HER
        const ADMIN_EMAILS = [
            'mma@scaleup.finance',
            'jbo@scaleup.finance'
        ];
        
        // ROLLER DEFINITIONER
        const USER_ROLES = {
            super_admin: {
                canViewAll: true,
                canEditAll: true,
                canDeleteProjects: true,
                canManageUsers: true,
                canChangeRoles: true,
                canDeleteUsers: true,
                badgeClass: 'role-super-admin',
                label: 'üëë Super Admin'
            },
            admin: {
                canViewAll: true,
                canEditAll: true,
                canDeleteProjects: true,
                canManageUsers: true,
                canChangeRoles: false,
                canDeleteUsers: false,
                badgeClass: 'role-admin',
                label: 'üü† Admin'
            },
            project_manager: {
                canViewAll: true,
                canEditAll: true,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                badgeClass: 'role-project-manager',
                label: 'üü° Project Manager'
            },
            team_lead: {
                canViewAll: true,
                canEditAll: false,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                badgeClass: 'role-team-lead',
                label: 'üü¢ Team Lead'
            },
            user: {
                canViewAll: false,
                canEditAll: false,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                badgeClass: 'role-user',
                label: '‚ö™ User'
            }
        };
        
        let supabase = null;
        let currentUser = null;
        let currentUserRole = 'user';
        let currentProjectId = null;
        let currentProjectData = null;
        
        // Master template for new projects
        const masterTemplate = [
            {
                phase: "Phase 1: Analysis & Planning",
                tasks: [
                    {name: "1.1 Requirements Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Map dimension requirements and needs"},
                    {name: "1.2 System Mapping", status: "not-started", responsible: "Client", description: "Current setup in all systems"},
                    {name: "1.3 Gap Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Identify change requirements"},
                    {name: "1.4 Technical Architecture", status: "not-started", responsible: "Scaleup Finance", description: "Design solution architecture"}
                ]
            },
            {
                phase: "Phase 2: e-conomic Configuration",
                tasks: [
                    {name: "2.1 Dimension Setup", status: "not-started", responsible: "Scaleup Finance", description: "Create dimensions in e-conomic"},
                    {name: "2.2 Chart of Accounts Adaptation", status: "not-started", responsible: "Scaleup Finance", description: "Update chart of accounts"},
                    {name: "2.3 Report Configuration", status: "not-started", responsible: "Scaleup Finance", description: "Customize standard reports"},
                    {name: "2.4 User Permissions", status: "not-started", responsible: "Client", description: "Setup user access rights"}
                ]
            },
            {
                phase: "Phase 3: Corpay Integration",
                tasks: [
                    {name: "3.1 Corpay Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Corpay"},
                    {name: "3.2 e-conomic Mapping", status: "not-started", responsible: "Scaleup Finance", description: "System mapping between platforms"},
                    {name: "3.3 Data Import Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test data transfer processes"},
                    {name: "3.4 Automation Rules", status: "not-started", responsible: "Scaleup Finance", description: "Setup automatic posting rules"}
                ]
            },
            {
                phase: "Phase 4: Pleo Integration",
                tasks: [
                    {name: "4.1 Pleo Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Pleo"},
                    {name: "4.2 Employee Training", status: "not-started", responsible: "Client", description: "Train employees on dimension usage"},
                    {name: "4.3 Approval Workflows", status: "not-started", responsible: "Client", description: "Setup approval processes"},
                    {name: "4.4 Integration Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test Pleo to e-conomic integration"}
                ]
            },
            {
                phase: "Phase 5: Testing & Validation",
                tasks: [
                    {name: "5.1 System Testing", status: "not-started", responsible: "Scaleup Finance", description: "Functional testing of all systems"},
                    {name: "5.2 User Acceptance Testing", status: "not-started", responsible: "Client", description: "Testing with end users"},
                    {name: "5.3 Report Validation", status: "not-started", responsible: "Scaleup Finance", description: "Verify report accuracy"},
                    {name: "5.4 Performance Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test system performance"}
                ]
            },
            {
                phase: "Phase 6: Go-Live & Support",
                tasks: [
                    {name: "6.1 Production Implementation", status: "not-started", responsible: "Scaleup Finance", description: "Deploy to production environment"},
                    {name: "6.2 User Training", status: "not-started", responsible: "Scaleup Finance", description: "Train all users"},
                    {name: "6.3 Documentation", status: "not-started", responsible: "Scaleup Finance", description: "Create user manuals"},
                    {name: "6.4 Post-Implementation Support", status: "not-started", responsible: "Scaleup Finance", description: "Ongoing support first month"}
                ]
            }
        ];
        
        // Initialize Supabase
        try {
            if (supabaseUrl !== 'https://YOUR-PROJECT-REF.supabase.co') {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                checkAuth();
            } else {
                console.error('Please configure Supabase credentials');
                alert('Supabase er ikke konfigureret. Opdater credentials i HTML filen.');
            }
        } catch (error) {
            console.error('Supabase initialization error:', error);
        }
        
        // Logo upload handler
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('V√¶lg venligst en gyldig billedfil (JPG, PNG, eller GIF)');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Billedet er for stort. Maksimal st√∏rrelse er 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function (e) {
                // Update main header logo
                const headerLogo = document.getElementById('header-logo');
                const logoFallback = document.getElementById('logo-fallback');
                
                if (headerLogo) {
                    headerLogo.src = e.target.result;
                    headerLogo.style.display = 'block';
                }
                if (logoFallback) {
                    logoFallback.style.display = 'none';
                }
                
                // Show preview
                const previewDiv = document.getElementById('upload-preview');
                const previewImg = document.getElementById('preview-image');
                if (previewDiv && previewImg) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                }
                
                // Save logo data to project
                if (currentProjectData) {
                    if (!currentProjectData.client_data) {
                        currentProjectData.client_data = {};
                    }
                    currentProjectData.client_data.logo = e.target.result;
                    saveToSupabase();
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // Authentication Functions
        async function checkAuth() {
            if (!supabase) return;
            
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                await getUserRole();
                showDashboard();
            } else {
                showLoginScreen();
            }
        }
        
        // Get user role
        async function getUserRole() {
            if (!currentUser) return;
            
            // Check if user is admin
            if (ADMIN_EMAILS.includes(currentUser.email)) {
                currentUserRole = 'super_admin';
            } else {
                // Check database for role
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('role')
                        .eq('email', currentUser.email)
                        .single();
                    
                    if (data && data.role) {
                        currentUserRole = data.role;
                    }
                } catch (error) {
                    console.log('No user role found, defaulting to user');
                }
            }
            
            updateUIForRole();
        }
        
        // Update UI based on role
        function updateUIForRole() {
            const role = USER_ROLES[currentUserRole];
            
            // Update role badge
            const roleBadge = document.getElementById('current-user-role');
            if (roleBadge) {
                roleBadge.textContent = role.label;
                roleBadge.className = `role-badge ${role.badgeClass}`;
            }
            
            // Show/hide admin features
            const adminBtn = document.getElementById('admin-btn');
            const adminTab = document.getElementById('admin-tab');
            
            if (role.canManageUsers) {
                if (adminBtn) adminBtn.style.display = 'block';
                if (adminTab) adminTab.style.display = 'block';
            } else {
                if (adminBtn) adminBtn.style.display = 'none';
                if (adminTab) adminTab.style.display = 'none';
            }
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            loadUserProjects().then(() => {
                // Check if there's a project in URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const projectFromURL = urlParams.get('project');
                if (projectFromURL) {
                    document.getElementById('project-select').value = projectFromURL;
                    loadProject(projectFromURL);
                }
            });
        }
        
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            clearMessages();
        }
        
        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            clearMessages();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }
        
        function clearMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showError('Login fejlede: ' + error.message);
            } else {
                currentUser = data.user;
                await getUserRole();
                showDashboard();
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const companyName = document.getElementById('company-name').value;
            
            if (!email || !password || !companyName) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            if (password.length < 6) {
                showError('Password skal v√¶re mindst 6 tegn');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        company_name: companyName
                    }
                }
            });
            
            if (error) {
                showError('Oprettelse fejlede: ' + error.message);
            } else {
                // Create user record
                if (data.user) {
                    await supabase
                        .from('users')
                        .insert([{
                            id: data.user.id,
                            email: email,
                            role: 'user',
                            company_name: companyName
                        }]);
                }
                
                showSuccess('Konto oprettet! Du kan nu logge ind.');
                setTimeout(() => showLogin(), 3000);
            }
        }
        
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                currentUser = null;
                showLoginScreen();
            }
        }
        
        // Load user's projects FIXED
        async function loadUserProjects() {
            if (!supabase || !currentUser) return Promise.resolve();
            
            const role = USER_ROLES[currentUserRole];
            
            try {
                let query = supabase
                    .from('projects')
                    .select('project_id, client_data, user_id, shared_with');
                
                // Depending on role, filter projects
                if (!role.canViewAll) {
                    // Regular users see only their own + shared projects
                    query = query.or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.email}}`);
                }
                // Admins and managers see all projects
                
                const { data: projects, error } = await query;

                if (error) {
                    console.error('Error loading projects:', error);
                    return;
                }

                const select = document.getElementById('project-select');
                if (select) {
                    select.innerHTML = '<option value="">V√¶lg eller opret et projekt...</option>';
                    
                    if (projects && projects.length > 0) {
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            const clientName = project.client_data?.name || 'Unavngivet projekt';
                            
                            // Add badge if shared
                            if (project.shared_with && 
                                project.shared_with.includes(currentUser.email) && 
                                project.user_id !== currentUser.id) {
                                option.textContent = `${clientName} (Delt med dig)`;
                            } else {
                                option.textContent = clientName;
                            }
                            
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error.message);
            }
        }
        
        // Create new project
        async function createNewProject() {
            if (!currentUser) {
                alert('Du skal v√¶re logget ind for at oprette projekter');
                return;
            }
            
            const projectName = prompt('Indtast kundens firmanavn:');
            if (!projectName) return;
            
            const projectId = generateProjectId(projectName);
            currentProjectId = projectId;
            
            const newProject = {
                project_id: projectId,
                user_id: currentUser.id,
                client_data: {
                    name: projectName,
                    scaleupPM: '',
                    clientPM: '',
                    notes: ''
                },
                team_members: [],
                shared_with: [],
                tasks: masterTemplate,
                is_public: false,
                created_at: new Date().toISOString(),
                last_updated: new Date().toISOString()
            };
            
            if (supabase) {
                try {
                    const { error } = await supabase
                        .from('projects')
                        .insert([newProject]);
                    
                    if (error) throw error;
                    
                    await loadUserProjects();
                    document.getElementById('project-select').value = projectId;
                    loadProject(projectId);
                    alert('Projekt oprettet! üéâ');
                } catch (error) {
                    console.error('Error creating project:', error.message);
                    alert('Fejl ved oprettelse af projekt: ' + error.message);
                }
            }
        }
        
        // Team Members Functions FIXED
        function addTeamMember() {
            const nameInput = document.getElementById('new-member-name');
            const companySelect = document.getElementById('new-member-company');
            
            if (!nameInput || !companySelect) {
                console.error('Team member inputs not found');
                return;
            }
            
            const name = nameInput.value.trim();
            let company = companySelect.value;
            
            // Use actual client name if "Client" is selected
            if (company === 'Client' && currentProjectData?.client_data?.name) {
                company = currentProjectData.client_data.name;
            }
            
            if (!name) {
                alert('Indtast venligst et navn');
                return;
            }
            
            if (!currentProjectData) {
                alert('V√¶lg f√∏rst et projekt');
                return;
            }
            
            // Initialize team_members if it doesn't exist
            if (!currentProjectData.team_members) {
                currentProjectData.team_members = [];
            }
            
            // Check if member already exists
            if (currentProjectData.team_members.find(member => member.name === name)) {
                alert('Dette team medlem eksisterer allerede');
                return;
            }
            
            // Add new member
            currentProjectData.team_members.push({ 
                name: name, 
                company: company 
            });
            
            // Clear input
            nameInput.value = '';
            
            // Update display
            updateTeamMembersList();
            
            // Save to database
            saveToSupabase();
            
            // Update table to show new member in dropdowns
            populateTable();
            
            console.log('Team member added:', { name, company });
        }
        
        function removeTeamMember(name) {
            if (!confirm('Vil du fjerne dette team medlem?')) return;
            
            if (currentProjectData && currentProjectData.team_members) {
                currentProjectData.team_members = currentProjectData.team_members.filter(member => member.name !== name);
                updateTeamMembersList();
                saveToSupabase();
            }
        }
        
        function updateTeamMembersList() {
            const listDiv = document.getElementById('team-members-list');
            if (!listDiv) return;
            
            if (!currentProjectData?.team_members || currentProjectData.team_members.length === 0) {
                listDiv.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 20px;">Ingen team medlemmer tilf√∏jet endnu.</p>';
                return;
            }
            
            listDiv.innerHTML = currentProjectData.team_members.map(member => `
                <div class="team-member-item">
                    <div class="team-member-info">
                        <div class="team-member-name">
                            <span style="font-size: 1.2em;">${member.company === 'Scaleup Finance' ? 'üëî' : 'üë§'}</span>
                            ${member.name}
                        </div>
                        <div class="team-member-company">${member.company}</div>
                    </div>
                    <button onclick="removeTeamMember('${member.name}')" class="btn btn-danger btn-small">Fjern</button>
                </div>
            `).join('');
        }
        
        // Share project functionality FIXED
        function shareProject() {
            if (!currentProjectId) {
                alert('V√¶lg f√∏rst et projekt at dele');
                return;
            }
            
            const role = USER_ROLES[currentUserRole];
            
            // Check if user owns the project or has admin rights
            if (currentProjectData.user_id !== currentUser.id && !role.canEditAll) {
                alert('Du kan kun dele projekter du ejer eller har admin rettigheder til');
                return;
            }
            
            // Show modal
            document.getElementById('shareModal').style.display = 'block';
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
            document.getElementById('share-email').value = '';
        }
        
        async function confirmShare() {
            const email = document.getElementById('share-email').value.trim();
            
            if (!email) {
                alert('Indtast en email adresse');
                return;
            }
            
            if (!currentProjectData) return;
            
            // Initialize shared_with if it doesn't exist
            if (!currentProjectData.shared_with) {
                currentProjectData.shared_with = [];
            }
            
            // Check if already shared
            if (currentProjectData.shared_with.includes(email)) {
                alert('Projektet er allerede delt med denne bruger');
                return;
            }
            
            // Add to shared list
            currentProjectData.shared_with.push(email);
            
            // Save to database
            try {
                const { error } = await supabase
                    .from('projects')
                    .update({ 
                        shared_with: currentProjectData.shared_with,
                        last_updated: new Date().toISOString()
                    })
                    .eq('project_id', currentProjectId);
                
                if (error) throw error;
                
                // Create share link
                const shareLink = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
                
                alert(`‚úÖ Projekt delt med ${email}!\n\n` +
                      `Send denne besked til brugeren:\n\n` +
                      `"Du har f√•et adgang til projekt: ${currentProjectData.client_data?.name || 'Unavngivet'}\n\n` +
                      `Link: ${shareLink}\n\n` +
                      `Log ind med din email for at se projektet."`);
                
                // Note: For automatic email, you need to setup Supabase Edge Functions
                // or use a service like SendGrid/Resend via Supabase Functions
                // 
                // Example Edge Function setup:
                // 1. Install Supabase CLI
                // 2. Create edge function: supabase functions new send-share-email
                // 3. Add email service (Resend/SendGrid) in the function
                // 4. Deploy: supabase functions deploy send-share-email
                // 5. Call from here: await supabase.functions.invoke('send-share-email', { body: { email, projectId }})
                
                closeShareModal();
                
            } catch (error) {
                console.error('Error sharing project:', error);
                alert('Fejl ved deling af projekt');
            }
        }
        
        // Load project
        async function loadProject(projectId) {
            if (!projectId) {
                currentProjectId = null;
                resetUI();
                return;
            }
            
            currentProjectId = projectId;
            
            if (!supabase) return;
            
            try {
                let query = supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId);
                
                const role = USER_ROLES[currentUserRole];
                
                // Check permissions
                if (!role.canViewAll) {
                    // Regular users can only see their own or shared projects
                    query = query.or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.email}}`);
                }
                
                const { data: project, error } = await query.single();

                if (error) throw error;

                if (project) {
                    currentProjectData = project;
                    
                    // Ensure arrays exist
                    if (!currentProjectData.team_members) {
                        currentProjectData.team_members = [];
                    }
                    if (!currentProjectData.shared_with) {
                        currentProjectData.shared_with = [];
                    }
                    
                    populateUIFromProject(project);
                    updateTeamMembersList();
                }
            } catch (error) {
                console.error('Error loading project:', error.message);
                alert('Kunne ikke indl√¶se projekt');
            }
        }
        
        // Populate UI from project data
        function populateUIFromProject(projectData) {
            const clientData = projectData.client_data || {};
            document.getElementById('client-name').value = clientData.name || '';
            document.getElementById('scaleup-pm').value = clientData.scaleupPM || '';
            document.getElementById('client-pm').value = clientData.clientPM || '';
            document.getElementById('project-notes').value = clientData.notes || '';
            
            // Load logo if exists
            if (clientData.logo) {
                const headerLogo = document.getElementById('header-logo');
                const logoFallback = document.getElementById('logo-fallback');
                const previewDiv = document.getElementById('upload-preview');
                const previewImg = document.getElementById('preview-image');
                
                if (headerLogo) {
                    headerLogo.src = clientData.logo;
                    headerLogo.style.display = 'block';
                }
                if (logoFallback) {
                    logoFallback.style.display = 'none';
                }
                if (previewDiv && previewImg) {
                    previewImg.src = clientData.logo;
                    previewDiv.style.display = 'block';
                }
            }
            
            checkSetup();
            populateTable();
            updateDashboard();
        }
        
        // Save to Supabase FIXED
        async function saveToSupabase() {
            if (!currentProjectId || !supabase || !currentUser) return;
            
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                clientPM: document.getElementById('client-pm').value.trim(),
                notes: document.getElementById('project-notes').value.trim()
            };
            
            // Preserve logo if it exists
            if (currentProjectData?.client_data?.logo) {
                clientData.logo = currentProjectData.client_data.logo;
            }
            
            const currentData = {
                client_data: clientData,
                tasks: currentProjectData?.tasks || masterTemplate,
                team_members: currentProjectData?.team_members || [],
                shared_with: currentProjectData?.shared_with || [],
                last_updated: new Date().toISOString()
            };
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .update(currentData)
                    .eq('project_id', currentProjectId);
                
                if (error) {
                    console.error('Save error details:', error);
                    
                    // Check if columns exist
                    if (error.message.includes('column')) {
                        console.warn('Database schema issue. Please run the SQL migrations.');
                    }
                } else {
                    console.log('Data saved successfully');
                }
            } catch (error) {
                console.error('Failed to save to Supabase:', error.message);
            }
            
            currentProjectData = { ...currentProjectData, ...currentData };
        }
        
        // Generate project ID
        function generateProjectId(projectName) {
            const cleanName = projectName.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const timestamp = Date.now().toString().slice(-6);
            return `${cleanName}-${timestamp}`;
        }
        
        // Reset UI
        function resetUI() {
            document.getElementById('client-name').value = '';
            document.getElementById('scaleup-pm').value = '';
            document.getElementById('client-pm').value = '';
            document.getElementById('project-notes').value = '';
            checkSetup();
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            const targetTab = document.getElementById(tabName + '-tab');
            const targetNavTab = event ? event.target : document.querySelector(`.nav-tab:contains('${tabName}')`);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetNavTab) targetNavTab.classList.add('active');
            
            // Load admin data if admin tab
            if (tabName === 'admin' && USER_ROLES[currentUserRole].canManageUsers) {
                loadAdminData();
            }
            
            checkSetup();
        }
        
        // Load admin data
        async function loadAdminData() {
            if (!supabase) return;
            
            try {
                // Load all users
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');
                
                if (users) {
                    displayUsers(users);
                    document.getElementById('total-users').textContent = users.length;
                }
                
                // Load project stats
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('project_id, tasks');
                
                if (projects) {
                    document.getElementById('total-projects').textContent = projects.length;
                    
                    // Count active projects
                    let activeCount = 0;
                    projects.forEach(project => {
                        if (project.tasks) {
                            const hasActive = project.tasks.some(phase => 
                                phase.tasks.some(task => task.status === 'in-progress')
                            );
                            if (hasActive) activeCount++;
                        }
                    });
                    document.getElementById('active-projects').textContent = activeCount;
                }
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        // Display users in admin panel
        function displayUsers(users) {
            const userList = document.getElementById('user-list');
            if (!userList) return;
            
            userList.innerHTML = users.map(user => `
                <div class="user-row">
                    <div class="user-email">${user.email}</div>
                    <div>${user.company_name || '-'}</div>
                    <div>
                        <select class="role-select" onchange="changeUserRole('${user.id}', this.value)" ${!USER_ROLES[currentUserRole].canChangeRoles ? 'disabled' : ''}>
                            ${Object.keys(USER_ROLES).map(role => 
                                `<option value="${role}" ${user.role === role ? 'selected' : ''}>${USER_ROLES[role].label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-danger btn-small" onclick="deleteUser('${user.id}')" ${!USER_ROLES[currentUserRole].canDeleteUsers ? 'disabled' : ''}>Slet</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Change user role
        async function changeUserRole(userId, newRole) {
            if (!USER_ROLES[currentUserRole].canChangeRoles) {
                alert('Du har ikke rettigheder til at √¶ndre roller');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('Bruger rolle opdateret!');
                loadAdminData();
            } catch (error) {
                console.error('Error changing role:', error);
                alert('Fejl ved opdatering af rolle');
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (!USER_ROLES[currentUserRole].canDeleteUsers) {
                alert('Du har ikke rettigheder til at slette brugere');
                return;
            }
            
            if (!confirm('Er du sikker p√• at du vil slette denne bruger?')) return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('Bruger slettet');
                loadAdminData();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Fejl ved sletning af bruger');
            }
        }
        
        // Save setup
        function saveSetup() {
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                clientPM: document.getElementById('client-pm').value.trim(),
                notes: document.getElementById('project-notes').value.trim()
            };
            
            if (!clientData.name || !clientData.scaleupPM) {
                alert('Udfyld venligst kundenavn og Scaleup Finance PM');
                return;
            }
            
            saveToSupabase();
            switchTab('dashboard');
            document.querySelectorAll('.nav-tab')[1].click();
        }
        
        // Check setup
        function checkSetup() {
            const hasProject = currentProjectId !== null;
            const clientName = document.getElementById('client-name').value.trim();
            const scaleupPM = document.getElementById('scaleup-pm').value.trim();
            const hasSetup = hasProject && clientName && scaleupPM;
            
            // Update Client option in team member dropdown
            const clientOption = document.getElementById('client-company-option');
            if (clientOption && clientName) {
                clientOption.textContent = clientName;
            }
            
            const dashboardWarning = document.getElementById('dashboard-warning');
            const dashboardContent = document.getElementById('dashboard-content');
            const projectWarning = document.getElementById('project-warning');
            const projectContent = document.getElementById('project-content');
            
            if (hasSetup) {
                if (dashboardWarning) dashboardWarning.style.display = 'none';
                if (dashboardContent) dashboardContent.style.display = 'block';
                if (projectWarning) projectWarning.style.display = 'none';
                if (projectContent) projectContent.style.display = 'block';
                
                const clientDisplay = document.getElementById('client-display');
                if (clientDisplay) {
                    clientDisplay.textContent = `${clientName} | PM: ${scaleupPM}`;
                }
                
                populateTable();
                updateDashboard();
            } else {
                if (dashboardWarning) dashboardWarning.style.display = 'block';
                if (dashboardContent) dashboardContent.style.display = 'none';
                if (projectWarning) projectWarning.style.display = 'block';
                if (projectContent) projectContent.style.display = 'none';
            }
        }
        
        // Populate table
        function populateTable() {
            const tbody = document.getElementById('project-body');
            if (!tbody || !currentProjectData?.tasks) return;
            
            tbody.innerHTML = '';
            
            // Get all responsible options including team members
            const responsibleOptions = ['Scaleup Finance'];
            
            // Add client company name or "Client"
            const clientName = currentProjectData?.client_data?.name || 'Client';
            responsibleOptions.push(clientName);
            
            // Add team members
            if (currentProjectData.team_members && currentProjectData.team_members.length > 0) {
                currentProjectData.team_members.forEach(member => {
                    responsibleOptions.push(member.name);
                });
            }
            
            currentProjectData.tasks.forEach((phase, phaseIndex) => {
                const phaseRow = document.createElement('tr');
                phaseRow.innerHTML = `<td colspan="4" style="background: #3a4a47; color: white; font-weight: bold; padding: 15px;">${phase.phase}</td>`;
                tbody.appendChild(phaseRow);
                
                phase.tasks.forEach((task, taskIndex) => {
                    // Main task row
                    const taskRow = document.createElement('tr');
                    
                    // Check if task responsible is "Client" and update to actual client name
                    if (task.responsible === 'Client' && clientName !== 'Client') {
                        task.responsible = clientName;
                    }
                    
                    // Create responsible dropdown
                    let responsibleDropdown = '<select onchange="updateTaskResponsible(\'' + task.name + '\', this.value)" style="width: 100%; padding: 6px;">';
                    responsibleOptions.forEach(option => {
                        responsibleDropdown += `<option value="${option}" ${task.responsible === option ? 'selected' : ''}>${option}</option>`;
                    });
                    responsibleDropdown += '</select>';
                    
                    taskRow.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${task.name}</span>
                                <button class="btn btn-success btn-small" style="padding: 4px 8px; font-size: 0.8em;" onclick="showSubtaskDialog(${phaseIndex}, ${taskIndex})">
                                    ‚ûï Add Subtask
                                </button>
                            </div>
                        </td>
                        <td>
                            <select class="status-select status-${task.status}" onchange="updateTaskStatus('${task.name}', this.value)">
                                <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>‚è≥ Not Started</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>üîÑ In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                            </select>
                        </td>
                        <td>${responsibleDropdown}</td>
                        <td>${task.description}</td>
                    `;
                    tbody.appendChild(taskRow);
                    
                    // Add subtasks if any
                    if (task.subtasks && task.subtasks.length > 0) {
                        task.subtasks.forEach((subtask, subtaskIndex) => {
                            // Check if subtask responsible is "Client" and update
                            if (subtask.responsible === 'Client' && clientName !== 'Client') {
                                subtask.responsible = clientName;
                            }
                            
                            const subtaskRow = document.createElement('tr');
                            subtaskRow.style.background = '#f8f9fa';
                            
                            let subtaskResponsibleDropdown = '<select onchange="updateSubtaskResponsible(' + phaseIndex + ', ' + taskIndex + ', ' + subtaskIndex + ', this.value)" style="width: 100%; padding: 4px; font-size: 0.9em;">';
                            responsibleOptions.forEach(option => {
                                subtaskResponsibleDropdown += `<option value="${option}" ${subtask.responsible === option ? 'selected' : ''}>${option}</option>`;
                            });
                            subtaskResponsibleDropdown += '</select>';
                            
                            subtaskRow.innerHTML = `
                                <td style="padding-left: 40px;">
                                    ‚îî‚îÄ ${subtask.name}
                                    <button onclick="removeSubtask(${phaseIndex}, ${taskIndex}, ${subtaskIndex})" 
                                        style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 10px;">
                                        üóëÔ∏è
                                    </button>
                                </td>
                                <td>
                                    <select class="status-select status-${subtask.status}" 
                                        onchange="updateSubtaskStatus(${phaseIndex}, ${taskIndex}, ${subtaskIndex}, this.value)">
                                        <option value="not-started" ${subtask.status === 'not-started' ? 'selected' : ''}>‚è≥ Not Started</option>
                                        <option value="in-progress" ${subtask.status === 'in-progress' ? 'selected' : ''}>üîÑ In Progress</option>
                                        <option value="completed" ${subtask.status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                                    </select>
                                </td>
                                <td>${subtaskResponsibleDropdown}</td>
                                <td style="font-size: 0.9em;">${subtask.description || 'Custom subtask'}</td>
                            `;
                            tbody.appendChild(subtaskRow);
                        });
                    }
                });
            });
        }
        
        // Subtask functions
        function showSubtaskDialog(phaseIndex, taskIndex) {
            const task = currentProjectData.tasks[phaseIndex].tasks[taskIndex];
            const subtaskName = prompt(`Tilf√∏j subtask til: ${task.name}\n\nIndtast subtask navn:`);
            
            if (subtaskName && subtaskName.trim()) {
                if (!task.subtasks) {
                    task.subtasks = [];
                }
                
                const taskNumber = task.name.split(' ')[0];
                const subtaskNumber = task.subtasks.length + 1;
                const fullSubtaskNumber = `${taskNumber}.${subtaskNumber}`;
                
                task.subtasks.push({
                    name: `${fullSubtaskNumber} ${subtaskName.trim()}`,
                    status: 'not-started',
                    responsible: task.responsible,
                    description: 'Custom subtask'
                });
                
                populateTable();
                updateDashboard();
                saveToSupabase();
            }
        }
        
        function removeSubtask(phaseIndex, taskIndex, subtaskIndex) {
            if (confirm('Vil du fjerne denne subtask?')) {
                currentProjectData.tasks[phaseIndex].tasks[taskIndex].subtasks.splice(subtaskIndex, 1);
                populateTable();
                updateDashboard();
                saveToSupabase();
            }
        }
        
        function updateSubtaskStatus(phaseIndex, taskIndex, subtaskIndex, status) {
            currentProjectData.tasks[phaseIndex].tasks[taskIndex].subtasks[subtaskIndex].status = status;
            if (event && event.target) {
                event.target.className = `status-select status-${status}`;
            }
            updateDashboard();
            saveToSupabase();
        }
        
        function updateSubtaskResponsible(phaseIndex, taskIndex, subtaskIndex, responsible) {
            currentProjectData.tasks[phaseIndex].tasks[taskIndex].subtasks[subtaskIndex].responsible = responsible;
            updateDashboard();
            saveToSupabase();
        }
        
        // Update dashboard
        function updateDashboard() {
            if (!currentProjectData?.tasks) return;
            
            let totalTasks = 0;
            let completedTasks = 0;
            let ongoingTasks = 0;
            let tasksByResponsible = {};
            
            // Get client name
            const clientName = currentProjectData?.client_data?.name || 'Client';
            
            currentProjectData.tasks.forEach(phase => {
                phase.tasks.forEach(task => {
                    // Update task responsible if it's "Client"
                    if (task.responsible === 'Client' && clientName !== 'Client') {
                        task.responsible = clientName;
                    }
                    
                    totalTasks++;
                    if (task.status === 'completed') completedTasks++;
                    if (task.status === 'in-progress') ongoingTasks++;
                    
                    // Count by responsible
                    if (!tasksByResponsible[task.responsible]) {
                        tasksByResponsible[task.responsible] = {
                            total: 0,
                            completed: 0,
                            inProgress: 0,
                            notStarted: 0
                        };
                    }
                    tasksByResponsible[task.responsible].total++;
                    if (task.status === 'completed') tasksByResponsible[task.responsible].completed++;
                    else if (task.status === 'in-progress') tasksByResponsible[task.responsible].inProgress++;
                    else tasksByResponsible[task.responsible].notStarted++;
                    
                    // Count subtasks
                    if (task.subtasks) {
                        task.subtasks.forEach(subtask => {
                            // Update subtask responsible if it's "Client"
                            if (subtask.responsible === 'Client' && clientName !== 'Client') {
                                subtask.responsible = clientName;
                            }
                            
                            totalTasks++;
                            if (subtask.status === 'completed') completedTasks++;
                            if (subtask.status === 'in-progress') ongoingTasks++;
                            
                            if (!tasksByResponsible[subtask.responsible]) {
                                tasksByResponsible[subtask.responsible] = {
                                    total: 0,
                                    completed: 0,
                                    inProgress: 0,
                                    notStarted: 0
                                };
                            }
                            tasksByResponsible[subtask.responsible].total++;
                            if (subtask.status === 'completed') tasksByResponsible[subtask.responsible].completed++;
                            else if (subtask.status === 'in-progress') tasksByResponsible[subtask.responsible].inProgress++;
                            else tasksByResponsible[subtask.responsible].notStarted++;
                        });
                    }
                });
            });
            
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('overall-progress').textContent = progressPercent + '%';
            document.getElementById('overall-progress-bar').style.width = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('ongoing-tasks').textContent = ongoingTasks;
            
            // Find next milestone
            let nextMilestone = 'All tasks completed';
            for (const phase of currentProjectData.tasks) {
                for (const task of phase.tasks) {
                    if (task.status !== 'completed') {
                        nextMilestone = task.name.split(' ').slice(1).join(' ');
                        break;
                    }
                }
                if (nextMilestone !== 'All tasks completed') break;
            }
            document.getElementById('next-milestone').textContent = nextMilestone;
            
            // Update team performance dashboard
            updateTeamPerformance(tasksByResponsible);
        }
        
        // Team performance dashboard
        function updateTeamPerformance(tasksByResponsible) {
            // Add team performance section after KPI cards
            let performanceSection = document.getElementById('team-performance');
            if (!performanceSection) {
                const dashboardContent = document.getElementById('dashboard-content');
                if (!dashboardContent) return;
                
                performanceSection = document.createElement('div');
                performanceSection.id = 'team-performance';
                performanceSection.style.cssText = 'background: white; padding: 30px; border-radius: 12px; margin-top: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);';
                dashboardContent.appendChild(performanceSection);
            }
            
            let html = '<h3 style="color: #3a4a47; margin-bottom: 20px;">üë• Team Performance</h3>';
            html += '<div style="display: grid; gap: 15px;">';
            
            const clientName = currentProjectData?.client_data?.name || 'Client';
            
            Object.keys(tasksByResponsible).forEach(responsible => {
                const data = tasksByResponsible[responsible];
                const completionRate = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
                
                // Determine icon based on responsible
                let icon = 'üë§';
                if (responsible === 'Scaleup Finance') {
                    icon = 'üè¢';
                } else if (responsible === clientName || responsible === 'Client') {
                    icon = 'üèõÔ∏è';
                }
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3a4a47;">
                        <div style="font-weight: 600; color: #3a4a47;">
                            ${icon} ${responsible}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                ‚úÖ ${data.completed} done
                            </span>
                            <span style="background: #cce5ff; color: #004085; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                üîÑ ${data.inProgress} active
                            </span>
                            <span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                ‚è≥ ${data.notStarted} waiting
                            </span>
                            <span style="background: #3a4a47; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                                ${completionRate}%
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            performanceSection.innerHTML = html;
        }
        
        // Update task status
        async function updateTaskStatus(taskName, status) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.status = status;
                        if (event && event.target) {
                            event.target.className = `status-select status-${status}`;
                        }
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Update task responsible
        async function updateTaskResponsible(taskName, newResponsible) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.responsible = newResponsible;
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Export project
        function exportProject() {
            if (!currentProjectData) return;
            
            const exportData = {
                ...currentProjectData,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scaleup-project-${currentProjectId}.json`;
            a.click();
        }
        
        // Add auth state listener
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    getUserRole().then(() => showDashboard());
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showLoginScreen();
                }
            });
        }
        
        // Modal close on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('shareModal');
            if (event.target == modal) {
                closeShareModal();
            }
        }
    </script>
</body>
</html>