<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaleup Finance - Secure Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 74, 71, 0.3);
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .auth-toggle a {
            color: #3a4a47;
            text-decoration: none;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* User Info Bar */
        .user-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            font-weight: 600;
            color: #3a4a47;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #ff4500, #ff6500);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Admin Panel Styles */
        .admin-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid #ff4500;
        }
        
        .admin-panel h3 {
            color: #ff4500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .users-table tr:hover {
            background: #f8f9fa;
        }
        
        .role-select {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-view {
            background: #17a2b8;
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* CENTERED HEADER */
        .header { 
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
            color: white; 
            padding: 50px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 30px;
        }
        
        .scaleup-logo {
            width: 100px; 
            height: 100px; 
            background: #ffffff; 
            border-radius: 15px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .scaleup-logo img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .logo-fallback {
            color: #3a4a47; 
            font-size: 36px; 
            font-weight: 800;
        }
        
        .company-name {
            font-size: 4em;
            font-weight: 700;
            color: white;
        }
        
        .header-description {
            font-size: 1.3em;
            opacity: 0.9;
            text-align: center;
        }
        
        /* Project Controls */
        .project-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            min-width: 250px;
        }
        
        .nav-tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .nav-tab { flex: 1; padding: 15px 25px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; }
        .nav-tab.active { background: linear-gradient(135deg, #3a4a47, #2d3a36); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .setup-form { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-family: 'Segoe UI', sans-serif; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #3a4a47; color: white; }
        .btn-primary:hover { background: #2d3a36; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ff4500; color: white; }
        
        /* Dashboard and other styles */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        
        .kpi-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(58, 74, 71, 0.15); 
            text-align: center; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(58, 74, 71, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(58, 74, 71, 0.2);
        }
        
        .kpi-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 8px 16px rgba(58, 74, 71, 0.3);
        }
        
        .kpi-value { 
            font-size: 3.5em; 
            font-weight: 800; 
            margin: 20px 0 10px; 
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .kpi-label { 
            color: #666; 
            font-size: 1.1em; 
            font-weight: 600;
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 15px;
        }
        
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 20px 0 10px;
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3a4a47, #2d3a36, #3a4a47); 
            border-radius: 10px; 
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .kpi-subtitle {
            font-size: 0.9em;
            color: #3a4a47;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .dashboard-intro {
            background: linear-gradient(135deg, rgba(58, 74, 71, 0.05) 0%, rgba(45, 58, 54, 0.05) 100%);
            border: 1px solid rgba(58, 74, 71, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-intro h2 {
            color: #3a4a47;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .dashboard-intro p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; }
        
        .table-header { background: #3a4a47; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .client-info { font-size: 1.1em; opacity: 0.9; }
        
        .status-select { padding: 8px 12px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; }
        .status-completed { background: #28a745; color: white; }
        .status-in-progress { background: #3a4a47; color: white; }
        .status-not-started { background: #e9ecef; color: #495057; }
        
        .warning-message { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        .team-section {
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
            border: 2px solid #3a4a47;
        }
        
        .team-section h3 {
            color: #3a4a47; 
            margin-bottom: 15px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ff4500 0%, #ff6500 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <h1>Scaleup Finance</h1>
                <p>e-conomic Dimensions Dashboard</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2 style="margin-bottom: 20px;">Log ind</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button onclick="handleLogin()">Log ind</button>
                <div class="auth-toggle">
                    Ny bruger? <a href="#" onclick="showSignup(); return false;">Opret konto</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <h2 style="margin-bottom: 20px;">Opret konto</h2>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6 tegn)" required>
                <input type="text" id="company-name" placeholder="Firmanavn" required>
                <button onclick="handleSignup()">Opret konto</button>
                <div class="auth-toggle">
                    Har du allerede en konto? <a href="#" onclick="showLogin(); return false;">Log ind</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until logged in) -->
    <div id="main-dashboard" class="container" style="display: none;">
        
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info">
                <span>Logget ind som:</span>
                <span class="user-email" id="current-user-email">-</span>
                <span id="user-role-badge" class="admin-badge" style="display: none;">ADMIN</span>
            </div>
            <div>
                <button id="admin-menu-btn" class="btn btn-warning" onclick="switchTab('admin')" style="display: none;">üëë Admin Panel</button>
                <button class="btn btn-danger" onclick="handleLogout()">Log ud</button>
            </div>
        </div>
        
        <!-- CENTERED HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="scaleup-logo">
                    <img id="header-logo" style="display: none;" alt="Company Logo">
                    <div class="logo-fallback" id="logo-fallback">SF</div>
                </div>
                <div class="company-name">Scaleup Finance</div>
            </div>
            <div class="header-description">e-conomic Dimensions Implementation Dashboard</div>
        </div>

        <!-- Project Controls -->
        <div class="project-controls">
            <div class="project-info">
                <label style="font-weight: 600; color: #495057;">Current Project:</label>
                <select id="project-select" class="project-select" onchange="loadProject(this.value)">
                    <option value="">V√¶lg eller opret et projekt...</option>
                </select>
                <span id="connection-status" class="status-badge status-online" style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">Online</span>
            </div>
            <div>
                <button class="btn btn-success" onclick="createNewProject()">üîÑ Nyt Projekt</button>
                <button class="btn btn-secondary" onclick="exportProject()">üíæ Export</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">üîß Client Setup</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('project')">üìã Project Plan</button>
            <button id="admin-tab" class="nav-tab" onclick="switchTab('admin')" style="display: none;">üëë Admin</button>
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab-content" class="tab-content">
            <div class="admin-panel">
                <h3>üëë Administrator Panel</h3>
                
                <!-- Admin Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-users-count">0</div>
                        <div class="stat-label">Total Brugere</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-projects-count">0</div>
                        <div class="stat-label">Total Projekter</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="admin-count">0</div>
                        <div class="stat-label">Administratorer</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-projects-count">0</div>
                        <div class="stat-label">Aktive Projekter</div>
                    </div>
                </div>

                <!-- User Management -->
                <div style="margin-top: 30px;">
                    <h4 style="color: #3a4a47; margin-bottom: 20px;">üë• Brugeradministration</h4>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Firma</th>
                                <th>Rolle</th>
                                <th>Oprettet</th>
                                <th>Projekter</th>
                                <th>Handlinger</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="6" class="loading">Indl√¶ser brugere...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Project Overview for Admins -->
                <div style="margin-top: 30px;">
                    <h4 style="color: #3a4a47; margin-bottom: 20px;">üìÅ Alle Projekter</h4>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Projekt ID</th>
                                <th>Kunde</th>
                                <th>Ejer</th>
                                <th>Status</th>
                                <th>Oprettet</th>
                                <th>Handlinger</th>
                            </tr>
                        </thead>
                        <tbody id="all-projects-table-body">
                            <tr>
                                <td colspan="6" class="loading">Indl√¶ser projekter...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Client Setup Tab -->
        <div id="setup-tab" class="tab-content active">
            <div class="setup-form">
                <h2>Client Information Setup</h2>
                <p style="margin-bottom: 25px; color: #666;">Configure client details for this project.</p>
                
                <div class="form-group">
                    <label>Client Company Name *</label>
                    <input type="text" id="client-name" placeholder="e.g., ABC Corporation" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Scaleup Finance Project Manager *</label>
                    <input type="text" id="scaleup-pm" placeholder="e.g., Lars Jensen" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Client Project Manager</label>
                    <input type="text" id="client-pm" placeholder="e.g., John Smith (CFO)" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Project Notes (Optional)</label>
                    <textarea id="project-notes" rows="3" placeholder="Any specific notes about this implementation..." onchange="saveToSupabase()"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSetup()">üíæ Save Client Setup</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div id="dashboard-warning" class="warning-message">
                ‚ö†Ô∏è Please select a project and complete the Client Setup first to view the dashboard.
            </div>
            
            <div id="dashboard-content" style="display: none;">
                <div class="dashboard-intro">
                    <h2>üìä Project Overview</h2>
                    <p>Monitor your e-conomic dimensions implementation progress.</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-label">Overall Progress</div>
                        <div class="kpi-value" id="overall-progress">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overall-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="kpi-subtitle">Implementation Status</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-label">Completed Tasks</div>
                        <div class="kpi-value" id="completed-tasks">0</div>
                        <div class="kpi-subtitle">of <span id="total-tasks">0</span> total tasks</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">üîÑ</div>
                        <div class="kpi-label">Active Tasks</div>
                        <div class="kpi-value" id="ongoing-tasks">0</div>
                        <div class="kpi-subtitle">currently in progress</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">üéØ</div>
                        <div class="kpi-label">Next Milestone</div>
                        <div class="kpi-value" style="font-size: 1.8em; line-height: 1.2;" id="next-milestone">Requirements Analysis</div>
                        <div class="kpi-subtitle">Phase 1 - Analysis</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Plan Tab -->
        <div id="project-tab" class="tab-content">
            <div id="project-warning" class="warning-message">
                ‚ö†Ô∏è Please select a project and complete the Client Setup first to access the project plan.
            </div>
            
            <div id="project-content" style="display: none;">
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <div class="table-header">
                        <h2>üìã Detailed Project Plan</h2>
                        <div class="client-info" id="client-display">No project selected</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 350px">Task</th>
                                <th style="width: 150px">Status</th>
                                <th style="width: 200px">Responsible</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="project-body">
                            <tr>
                                <td colspan="4" class="loading">Select a project to view tasks...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR VALUES
        const supabaseUrl = 'https://swlnojbzlfosjdtqswjd.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bG5vamJ6bGZvc2pkdHFzd2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDUzNzIsImV4cCI6MjA3MjkyMTM3Mn0.weAmKGGMeUaerNwyAoz6dpFufK0Fz1YbrdaUzsKiYk8';
        
        let supabase = null;
        let currentUser = null;
        let currentUserRole = 'user'; // Default role
        let currentProjectId = null;
        let currentProjectData = null;
        
        // Master template for new projects
        const masterTemplate = [
            {
                phase: "Phase 1: Analysis & Planning",
                tasks: [
                    {name: "1.1 Requirements Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Map dimension requirements and needs"},
                    {name: "1.2 System Mapping", status: "not-started", responsible: "Client", description: "Current setup in all systems"},
                    {name: "1.3 Gap Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Identify change requirements"},
                    {name: "1.4 Technical Architecture", status: "not-started", responsible: "Scaleup Finance", description: "Design solution architecture"}
                ]
            },
            {
                phase: "Phase 2: e-conomic Configuration",
                tasks: [
                    {name: "2.1 Dimension Setup", status: "not-started", responsible: "Scaleup Finance", description: "Create dimensions in e-conomic"},
                    {name: "2.2 Chart of Accounts Adaptation", status: "not-started", responsible: "Scaleup Finance", description: "Update chart of accounts"},
                    {name: "2.3 Report Configuration", status: "not-started", responsible: "Scaleup Finance", description: "Customize standard reports"},
                    {name: "2.4 User Permissions", status: "not-started", responsible: "Client", description: "Setup user access rights"}
                ]
            },
            {
                phase: "Phase 3: Corpay Integration",
                tasks: [
                    {name: "3.1 Corpay Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Corpay"},
                    {name: "3.2 e-conomic Mapping", status: "not-started", responsible: "Scaleup Finance", description: "System mapping between platforms"},
                    {name: "3.3 Data Import Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test data transfer processes"},
                    {name: "3.4 Automation Rules", status: "not-started", responsible: "Scaleup Finance", description: "Setup automatic posting rules"}
                ]
            },
            {
                phase: "Phase 4: Pleo Integration",
                tasks: [
                    {name: "4.1 Pleo Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Pleo"},
                    {name: "4.2 Employee Training", status: "not-started", responsible: "Client", description: "Train employees on dimension usage"},
                    {name: "4.3 Approval Workflows", status: "not-started", responsible: "Client", description: "Setup approval processes"},
                    {name: "4.4 Integration Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test Pleo to e-conomic integration"}
                ]
            },
            {
                phase: "Phase 5: Testing & Validation",
                tasks: [
                    {name: "5.1 System Testing", status: "not-started", responsible: "Scaleup Finance", description: "Functional testing of all systems"},
                    {name: "5.2 User Acceptance Testing", status: "not-started", responsible: "Client", description: "Testing with end users"},
                    {name: "5.3 Report Validation", status: "not-started", responsible: "Scaleup Finance", description: "Verify report accuracy"},
                    {name: "5.4 Performance Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test system performance"}
                ]
            },
            {
                phase: "Phase 6: Go-Live & Support",
                tasks: [
                    {name: "6.1 Production Implementation", status: "not-started", responsible: "Scaleup Finance", description: "Deploy to production environment"},
                    {name: "6.2 User Training", status: "not-started", responsible: "Scaleup Finance", description: "Train all users"},
                    {name: "6.3 Documentation", status: "not-started", responsible: "Scaleup Finance", description: "Create user manuals"},
                    {name: "6.4 Post-Implementation Support", status: "not-started", responsible: "Scaleup Finance", description: "Ongoing support first month"}
                ]
            }
        ];
        
        // Initialize Supabase
        try {
            if (supabaseUrl !== 'https://YOUR-PROJECT-REF.supabase.co') {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                checkAuth();
            } else {
                console.error('Please configure Supabase credentials');
                alert('Supabase er ikke konfigureret. Opdater credentials i HTML filen.');
            }
        } catch (error) {
            console.error('Supabase initialization error:', error);
        }
        
        // Authentication Functions
        async function checkAuth() {
            if (!supabase) return;
            
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                await checkUserRole();
                showDashboard();
            } else {
                showLoginScreen();
            }
        }
        
        // Check user role
        async function checkUserRole() {
            if (!supabase || !currentUser) return;
            
            try {
                // First check if users table exists and has role column
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userData && userData.role) {
                    currentUserRole = userData.role;
                } else {
                    // If user doesn't exist in users table, create them
                    await createUserRecord();
                }
                
                // Update UI based on role
                updateUIForRole();
                
            } catch (error) {
                console.log('Role check error (this is normal on first setup):', error);
                // Try to create the user record if it doesn't exist
                await createUserRecord();
            }
        }
        
        // Create user record in users table
        async function createUserRecord() {
            if (!supabase || !currentUser) return;
            
            try {
                // Default first user as admin, others as regular users
                const { data: existingUsers } = await supabase
                    .from('users')
                    .select('id')
                    .limit(1);
                
                const isFirstUser = !existingUsers || existingUsers.length === 0;
                const role = isFirstUser ? 'admin' : 'user';
                
                const { error } = await supabase
                    .from('users')
                    .upsert({
                        id: currentUser.id,
                        email: currentUser.email,
                        role: role,
                        company_name: currentUser.user_metadata?.company_name || '',
                        created_at: new Date().toISOString()
                    });
                
                if (!error) {
                    currentUserRole = role;
                    updateUIForRole();
                }
            } catch (error) {
                console.error('Error creating user record:', error);
            }
        }
        
        // Update UI based on user role
        function updateUIForRole() {
            const adminMenuBtn = document.getElementById('admin-menu-btn');
            const adminTab = document.getElementById('admin-tab');
            const userRoleBadge = document.getElementById('user-role-badge');
            
            if (currentUserRole === 'admin') {
                if (adminMenuBtn) adminMenuBtn.style.display = 'inline-block';
                if (adminTab) adminTab.style.display = 'block';
                if (userRoleBadge) userRoleBadge.style.display = 'inline-block';
            } else {
                if (adminMenuBtn) adminMenuBtn.style.display = 'none';
                if (adminTab) adminTab.style.display = 'none';
                if (userRoleBadge) userRoleBadge.style.display = 'none';
            }
        }
        
        // Load admin data
        async function loadAdminData() {
            if (!supabase || currentUserRole !== 'admin') return;
            
            try {
                // Load all users
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (users) {
                    displayUsers(users);
                    document.getElementById('total-users-count').textContent = users.length;
                    document.getElementById('admin-count').textContent = users.filter(u => u.role === 'admin').length;
                }
                
                // Load all projects
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (projects) {
                    displayAllProjects(projects);
                    document.getElementById('total-projects-count').textContent = projects.length;
                    
                    // Count active projects (with progress > 0)
                    let activeCount = 0;
                    projects.forEach(project => {
                        if (project.tasks) {
                            const hasProgress = project.tasks.some(phase => 
                                phase.tasks.some(task => task.status !== 'not-started')
                            );
                            if (hasProgress) activeCount++;
                        }
                    });
                    document.getElementById('active-projects-count').textContent = activeCount;
                }
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        // Display users in admin panel
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.company_name || '-'}</td>
                    <td>
                        <select class="role-select" onchange="updateUserRole('${user.id}', this.value)" ${user.id === currentUser.id ? 'disabled' : ''}>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString('da-DK')}</td>
                    <td>${user.project_count || 0}</td>
                    <td class="action-buttons">
                        <button class="btn-small btn-view" onclick="viewUserProjects('${user.id}')">Se Projekter</button>
                        ${user.id !== currentUser.id ? `<button class="btn-small btn-delete" onclick="deleteUser('${user.id}')">Slet</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Display all projects in admin panel
        function displayAllProjects(projects) {
            const tbody = document.getElementById('all-projects-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            projects.forEach(project => {
                const clientName = project.client_data?.name || 'Unavngivet';
                
                // Calculate progress
                let progress = 0;
                if (project.tasks) {
                    let totalTasks = 0;
                    let completedTasks = 0;
                    project.tasks.forEach(phase => {
                        phase.tasks.forEach(task => {
                            totalTasks++;
                            if (task.status === 'completed') completedTasks++;
                        });
                    });
                    progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.project_id}</td>
                    <td>${clientName}</td>
                    <td>${project.user_email || project.user_id}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: ${progress === 100 ? '#28a745' : '#3a4a47'}; transition: width 0.3s;"></div>
                            </div>
                            <span>${progress}%</span>
                        </div>
                    </td>
                    <td>${new Date(project.created_at).toLocaleDateString('da-DK')}</td>
                    <td class="action-buttons">
                        <button class="btn-small btn-view" onclick="viewProjectAsAdmin('${project.project_id}')">√Öbn</button>
                        <button class="btn-small btn-delete" onclick="deleteProject('${project.project_id}')">Slet</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update user role
        async function updateUserRole(userId, newRole) {
            if (!supabase || currentUserRole !== 'admin') return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', userId);
                
                if (!error) {
                    alert('Brugerrolle opdateret!');
                }
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('Fejl ved opdatering af rolle');
            }
        }
        
        // View user projects (admin)
        async function viewUserProjects(userId) {
            if (!supabase || currentUserRole !== 'admin') return;
            
            try {
                const { data: projects } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('user_id', userId);
                
                if (projects && projects.length > 0) {
                    let projectList = projects.map(p => `- ${p.client_data?.name || p.project_id}`).join('\n');
                    alert(`Brugerens projekter:\n\n${projectList}`);
                } else {
                    alert('Brugeren har ingen projekter');
                }
            } catch (error) {
                console.error('Error viewing user projects:', error);
            }
        }
        
        // View project as admin
        async function viewProjectAsAdmin(projectId) {
            if (!supabase || currentUserRole !== 'admin') return;
            
            // Load the project
            currentProjectId = projectId;
            await loadProject(projectId, true); // true = admin override
            
            // Switch to project tab
            switchTab('project');
        }
        
        // Delete user (admin only)
        async function deleteUser(userId) {
            if (!supabase || currentUserRole !== 'admin') return;
            
            if (!confirm('Er du sikker p√• at du vil slette denne bruger og alle deres projekter?')) return;
            
            try {
                // Delete user's projects first
                await supabase
                    .from('projects')
                    .delete()
                    .eq('user_id', userId);
                
                // Delete user
                await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                alert('Bruger slettet');
                loadAdminData();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Fejl ved sletning af bruger');
            }
        }
        
        // Delete project (admin only)
        async function deleteProject(projectId) {
            if (!supabase || currentUserRole !== 'admin') return;
            
            if (!confirm('Er du sikker p√• at du vil slette dette projekt?')) return;
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('project_id', projectId);
                
                if (!error) {
                    alert('Projekt slettet');
                    loadAdminData();
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Fejl ved sletning af projekt');
            }
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            loadUserProjects();
        }
        
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            clearMessages();
        }
        
        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            clearMessages();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }
        
        function clearMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showError('Login fejlede: ' + error.message);
            } else {
                currentUser = data.user;
                await checkUserRole();
                showDashboard();
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const companyName = document.getElementById('company-name').value;
            
            if (!email || !password || !companyName) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            if (password.length < 6) {
                showError('Password skal v√¶re mindst 6 tegn');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        company_name: companyName
                    }
                }
            });
            
            if (error) {
                showError('Oprettelse fejlede: ' + error.message);
            } else {
                // Create user record in users table
                if (data.user) {
                    await supabase
                        .from('users')
                        .insert({
                            id: data.user.id,
                            email: email,
                            company_name: companyName,
                            role: 'user', // Default role
                            created_at: new Date().toISOString()
                        });
                }
                
                showSuccess('Konto oprettet! Du kan nu logge ind.');
                setTimeout(() => showLogin(), 3000);
            }
        }
        
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                currentUser = null;
                currentUserRole = 'user';
                showLoginScreen();
            }
        }
        
        // Load user's projects
        async function loadUserProjects() {
            if (!supabase || !currentUser) return;
            
            try {
                let query = supabase
                    .from('projects')
                    .select('project_id, client_data');
                
                // If not admin, only show own projects
                if (currentUserRole !== 'admin') {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data: projects, error } = await query;

                if (error) throw error;

                const select = document.getElementById('project-select');
                if (select) {
                    select.innerHTML = '<option value="">V√¶lg eller opret et projekt...</option>';
                    
                    if (projects && projects.length > 0) {
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            const clientName = project.client_data?.name || 'Unavngivet projekt';
                            option.textContent = clientName;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error.message);
            }
        }
        
        // Create new project
        async function createNewProject() {
            if (!currentUser) {
                alert('Du skal v√¶re logget ind for at oprette projekter');
                return;
            }
            
            const projectName = prompt('Indtast kundens firmanavn:');
            if (!projectName) return;
            
            const projectId = generateProjectId(projectName);
            currentProjectId = projectId;
            
            const newProject = {
                project_id: projectId,
                user_id: currentUser.id,
                user_email: currentUser.email, // Store email for admin view
                client_data: {
                    name: projectName,
                    scaleupPM: '',
                    clientPM: '',
                    notes: ''
                },
                team_members: [],
                tasks: masterTemplate,
                is_public: false,
                created_at: new Date().toISOString(),
                last_updated: new Date().toISOString()
            };
            
            if (supabase) {
                try {
                    const { error } = await supabase
                        .from('projects')
                        .insert([newProject]);
                    
                    if (error) throw error;
                    
                    await loadUserProjects();
                    document.getElementById('project-select').value = projectId;
                    loadProject(projectId);
                } catch (error) {
                    console.error('Error creating project:', error.message);
                    alert('Fejl ved oprettelse af projekt: ' + error.message);
                }
            }
        }
        
        // Load project
        async function loadProject(projectId, adminOverride = false) {
            if (!projectId) {
                currentProjectId = null;
                resetUI();
                return;
            }
            
            currentProjectId = projectId;
            
            if (!supabase) return;
            
            try {
                let query = supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId);
                
                // If not admin override, check ownership
                if (!adminOverride && currentUserRole !== 'admin') {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data: project, error } = await query.single();

                if (error) throw error;

                if (project) {
                    currentProjectData = project;
                    populateUIFromProject(project);
                }
            } catch (error) {
                console.error('Error loading project:', error.message);
                if (!adminOverride) {
                    alert('Du har ikke adgang til dette projekt');
                }
            }
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabName === 'admin') {
                document.getElementById('admin-tab-content').classList.add('active');
                document.getElementById('admin-tab').classList.add('active');
                loadAdminData();
            } else {
                document.getElementById(tabName + '-tab').classList.add('active');
                event.target.classList.add('active');
            }
            
            checkSetup();
        }
        
        // Populate UI from project data
        function populateUIFromProject(projectData) {
            const clientData = projectData.client_data || {};
            document.getElementById('client-name').value = clientData.name || '';
            document.getElementById('scaleup-pm').value = clientData.scaleupPM || '';
            document.getElementById('client-pm').value = clientData.clientPM || '';
            document.getElementById('project-notes').value = clientData.notes || '';
            
            checkSetup();
            populateTable();
            updateDashboard();
        }
        
        // Save to Supabase
        async function saveToSupabase() {
            if (!currentProjectId || !supabase || !currentUser) return;
            
            const currentData = {
                client_data: {
                    name: document.getElementById('client-name').value.trim(),
                    scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                    clientPM: document.getElementById('client-pm').value.trim(),
                    notes: document.getElementById('project-notes').value.trim()
                },
                tasks: currentProjectData?.tasks || masterTemplate,
                last_updated: new Date().toISOString()
            };
            
            try {
                let query = supabase
                    .from('projects')
                    .update(currentData)
                    .eq('project_id', currentProjectId);
                
                // Only check user_id if not admin
                if (currentUserRole !== 'admin') {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { error } = await query;
                
                if (error) throw error;
            } catch (error) {
                console.error('Failed to save to Supabase:', error.message);
            }
            
            currentProjectData = { ...currentProjectData, ...currentData };
        }
        
        // Generate project ID
        function generateProjectId(projectName) {
            const cleanName = projectName.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const timestamp = Date.now().toString().slice(-6);
            return `${cleanName}-${timestamp}`;
        }
        
        // Reset UI
        function resetUI() {
            document.getElementById('client-name').value = '';
            document.getElementById('scaleup-pm').value = '';
            document.getElementById('client-pm').value = '';
            document.getElementById('project-notes').value = '';
            checkSetup();
        }
        
        // Save setup
        function saveSetup() {
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                clientPM: document.getElementById('client-pm').value.trim(),
                notes: document.getElementById('project-notes').value.trim()
            };
            
            if (!clientData.name || !clientData.scaleupPM) {
                alert('Udfyld venligst kundenavn og Scaleup Finance PM');
                return;
            }
            
            saveToSupabase();
            switchTab('dashboard');
            document.querySelectorAll('.nav-tab')[1].click();
        }
        
        // Check setup
        function checkSetup() {
            const hasProject = currentProjectId !== null;
            const clientName = document.getElementById('client-name').value.trim();
            const scaleupPM = document.getElementById('scaleup-pm').value.trim();
            const hasSetup = hasProject && clientName && scaleupPM;
            
            const dashboardWarning = document.getElementById('dashboard-warning');
            const dashboardContent = document.getElementById('dashboard-content');
            const projectWarning = document.getElementById('project-warning');
            const projectContent = document.getElementById('project-content');
            
            if (hasSetup) {
                if (dashboardWarning) dashboardWarning.style.display = 'none';
                if (dashboardContent) dashboardContent.style.display = 'block';
                if (projectWarning) projectWarning.style.display = 'none';
                if (projectContent) projectContent.style.display = 'block';
                
                const clientDisplay = document.getElementById('client-display');
                if (clientDisplay) {
                    clientDisplay.textContent = `${clientName} | PM: ${scaleupPM}`;
                }
                
                populateTable();
                updateDashboard();
            } else {
                if (dashboardWarning) dashboardWarning.style.display = 'block';
                if (dashboardContent) dashboardContent.style.display = 'none';
                if (projectWarning) projectWarning.style.display = 'block';
                if (projectContent) projectContent.style.display = 'none';
            }
        }
        
        // Populate table
        function populateTable() {
            const tbody = document.getElementById('project-body');
            if (!tbody || !currentProjectData?.tasks) return;
            
            tbody.innerHTML = '';
            
            currentProjectData.tasks.forEach(phase => {
                const phaseRow = document.createElement('tr');
                phaseRow.innerHTML = `<td colspan="4" style="background: #3a4a47; color: white; font-weight: bold; padding: 15px;">${phase.phase}</td>`;
                tbody.appendChild(phaseRow);
                
                phase.tasks.forEach(task => {
                    const taskRow = document.createElement('tr');
                    taskRow.innerHTML = `
                        <td>${task.name}</td>
                        <td>
                            <select class="status-select status-${task.status}" onchange="updateTaskStatus('${task.name}', this.value)">
                                <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>‚è≥ Not Started</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>üîÑ In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                            </select>
                        </td>
                        <td>
                            <select onchange="updateTaskResponsible('${task.name}', this.value)" style="width: 100%; padding: 6px;">
                                <option value="Scaleup Finance" ${task.responsible === 'Scaleup Finance' ? 'selected' : ''}>Scaleup Finance</option>
                                <option value="Client" ${task.responsible === 'Client' ? 'selected' : ''}>Client</option>
                            </select>
                        </td>
                        <td>${task.description}</td>
                    `;
                    tbody.appendChild(taskRow);
                });
            });
        }
        
        // Update dashboard
        function updateDashboard() {
            if (!currentProjectData?.tasks) return;
            
            let totalTasks = 0;
            let completedTasks = 0;
            let ongoingTasks = 0;
            
            currentProjectData.tasks.forEach(phase => {
                phase.tasks.forEach(task => {
                    totalTasks++;
                    if (task.status === 'completed') completedTasks++;
                    if (task.status === 'in-progress') ongoingTasks++;
                });
            });
            
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('overall-progress').textContent = progressPercent + '%';
            document.getElementById('overall-progress-bar').style.width = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('ongoing-tasks').textContent = ongoingTasks;
            
            // Find next milestone
            let nextMilestone = 'All tasks completed';
            for (const phase of currentProjectData.tasks) {
                for (const task of phase.tasks) {
                    if (task.status !== 'completed') {
                        nextMilestone = task.name.split(' ').slice(1).join(' ');
                        break;
                    }
                }
                if (nextMilestone !== 'All tasks completed') break;
            }
            document.getElementById('next-milestone').textContent = nextMilestone;
        }
        
        // Update task status
        async function updateTaskStatus(taskName, status) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.status = status;
                        if (event && event.target) {
                            event.target.className = `status-select status-${status}`;
                        }
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Update task responsible
        async function updateTaskResponsible(taskName, newResponsible) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.responsible = newResponsible;
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Export project
        function exportProject() {
            if (!currentProjectData) return;
            
            const exportData = {
                ...currentProjectData,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scaleup-project-${currentProjectId}.json`;
            a.click();
        }
        
        // Add auth state listener
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    checkUserRole();
                    showDashboard();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    currentUserRole = 'user';
                    showLoginScreen();
                }
            });
        }
    </script>
</body>
</html>