<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaleup Finance - Admin Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 74, 71, 0.3);
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .auth-toggle a {
            color: #3a4a47;
            text-decoration: none;
            font-weight: 600;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* User Info Bar */
        .user-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            font-weight: 600;
            color: #3a4a47;
        }
        
        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
        }
        
        .role-super_admin { background: #ff0000; }
        .role-admin { background: #ff4500; }
        .role-project_manager { background: #ffa500; }
        .role-team_lead { background: #32cd32; }
        .role-user { background: #808080; }
        
        /* CENTERED HEADER */
        .header { 
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
            color: white; 
            padding: 50px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 30px;
        }
        
        .scaleup-logo {
            width: 100px; 
            height: 100px; 
            background: #ffffff; 
            border-radius: 15px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .scaleup-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-fallback {
            color: #3a4a47; 
            font-size: 36px; 
            font-weight: 800;
        }
        
        .company-name {
            font-size: 4em;
            font-weight: 700;
            color: white;
        }
        
        .header-description {
            font-size: 1.3em;
            opacity: 0.9;
            text-align: center;
        }
        
        /* Project Controls */
        .project-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            min-width: 250px;
        }
        
        .nav-tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .nav-tab { flex: 1; padding: 15px 25px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; }
        .nav-tab.active { background: linear-gradient(135deg, #3a4a47, #2d3a36); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .setup-form { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; font-family: 'Segoe UI', sans-serif; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #3a4a47; color: white; }
        .btn-primary:hover { background: #2d3a36; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        
        /* Logo Upload Section */
        .logo-upload-section {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            position: relative;
        }
        
        .logo-preview {
            margin-top: 15px;
            display: none;
        }
        
        .logo-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .remove-logo-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .admin-panel h2 {
            color: #3a4a47;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .users-table tr:hover {
            background: #f8f9fa;
        }
        
        .role-select {
            padding: 6px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        /* Dashboard Styles */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        
        .kpi-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(58, 74, 71, 0.15); 
            text-align: center; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(58, 74, 71, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(58, 74, 71, 0.2);
        }
        
        .kpi-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 8px 16px rgba(58, 74, 71, 0.3);
        }
        
        .kpi-value { 
            font-size: 3.5em; 
            font-weight: 800; 
            margin: 20px 0 10px; 
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .kpi-label { 
            color: #666; 
            font-size: 1.1em; 
            font-weight: 600;
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 15px;
        }
        
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 20px 0 10px;
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3a4a47, #2d3a36, #3a4a47); 
            border-radius: 10px; 
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .kpi-subtitle {
            font-size: 0.9em;
            color: #3a4a47;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .dashboard-intro {
            background: linear-gradient(135deg, rgba(58, 74, 71, 0.05) 0%, rgba(45, 58, 54, 0.05) 100%);
            border: 1px solid rgba(58, 74, 71, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-intro h2 {
            color: #3a4a47;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .dashboard-intro p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; }
        
        .table-header { background: #3a4a47; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .client-info { font-size: 1.1em; opacity: 0.9; }
        
        .status-select { padding: 8px 12px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; }
        .status-completed { background: #28a745; color: white; }
        .status-in-progress { background: #3a4a47; color: white; }
        .status-not-started { background: #e9ecef; color: #495057; }
        
        .warning-message { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <h1>Scaleup Finance</h1>
                <p>e-conomic Dimensions Dashboard</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2 style="margin-bottom: 20px;">Log ind</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button onclick="handleLogin()">Log ind</button>
                <div class="auth-toggle">
                    Ny bruger? <a href="#" onclick="showSignup(); return false;">Opret konto</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <h2 style="margin-bottom: 20px;">Opret konto</h2>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6 tegn)" required>
                <input type="text" id="company-name" placeholder="Firmanavn" required>
                <button onclick="handleSignup()">Opret konto</button>
                <div class="auth-toggle">
                    Har du allerede en konto? <a href="#" onclick="showLogin(); return false;">Log ind</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until logged in) -->
    <div id="main-dashboard" class="container" style="display: none;">
        
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info">
                <span>Logget ind som:</span>
                <span class="user-email" id="current-user-email">-</span>
                <span class="role-badge" id="current-user-role">User</span>
            </div>
            <div>
                <button class="btn btn-warning" id="admin-btn" onclick="switchTab('admin')" style="display: none;">👥 Admin Panel</button>
                <button class="btn btn-danger" onclick="handleLogout()">Log ud</button>
            </div>
        </div>
        
        <!-- CENTERED HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="scaleup-logo">
                    <img id="header-logo" style="display: none;" alt="Company Logo">
                    <div class="logo-fallback" id="logo-fallback">SF</div>
                </div>
                <div class="company-name">Scaleup Finance</div>
            </div>
            <div class="header-description">e-conomic Dimensions Implementation Dashboard</div>
        </div>

        <!-- Project Controls -->
        <div class="project-controls">
            <div class="project-info">
                <label style="font-weight: 600; color: #495057;">Current Project:</label>
                <select id="project-select" class="project-select" onchange="loadProject(this.value)">
                    <option value="">Vælg eller opret et projekt...</option>
                </select>
            </div>
            <div>
                <button class="btn btn-success" onclick="createNewProject()">➕ Nyt Projekt</button>
                <button class="btn btn-info" id="share-btn" onclick="shareProject()" style="display: none;">🔗 Del Projekt</button>
                <button class="btn btn-secondary" onclick="exportProject()">💾 Export</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">🔧 Client Setup</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="switchTab('project')">📋 Project Plan</button>
            <button class="nav-tab" id="admin-tab" onclick="switchTab('admin')" style="display: none;">👥 Admin</button>
        </div>

        <!-- Client Setup Tab -->
        <div id="setup-tab" class="tab-content active">
            <div class="setup-form">
                <h2>Client Information Setup</h2>
                <p style="margin-bottom: 25px; color: #666;">Configure client details for this project.</p>
                
                <div class="form-group">
                    <label>Client Company Name *</label>
                    <input type="text" id="client-name" placeholder="e.g., ABC Corporation" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Upload Company Logo</label>
                    <div class="logo-upload-section">
                        <input type="file" id="logo-upload" accept="image/*" onchange="handleLogoUpload(event)">
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">Vælg en logofil (PNG, JPG, GIF - Max 2MB)</p>
                        <button class="remove-logo-btn" id="remove-logo-btn" onclick="removeLogo()" style="display: none;">🗑️ Fjern Logo</button>
                        <div class="logo-preview" id="logo-preview">
                            <img id="preview-image" alt="Logo preview">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Scaleup Finance Project Manager *</label>
                    <input type="text" id="scaleup-pm" placeholder="e.g., Lars Jensen" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Client Project Manager</label>
                    <input type="text" id="client-pm" placeholder="e.g., John Smith (CFO)" onchange="saveToSupabase()">
                </div>
                
                <div class="form-group">
                    <label>Project Notes (Optional)</label>
                    <textarea id="project-notes" rows="3" placeholder="Any specific notes about this implementation..." onchange="saveToSupabase()"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveSetup()">💾 Save Client Setup</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div id="dashboard-warning" class="warning-message">
                ⚠️ Please select a project and complete the Client Setup first to view the dashboard.
            </div>
            
            <div id="dashboard-content" style="display: none;">
                <div class="dashboard-intro">
                    <h2>📊 Project Overview</h2>
                    <p>Monitor your e-conomic dimensions implementation progress.</p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon">📈</div>
                        <div class="kpi-label">Overall Progress</div>
                        <div class="kpi-value" id="overall-progress">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overall-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="kpi-subtitle">Implementation Status</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">✅</div>
                        <div class="kpi-label">Completed Tasks</div>
                        <div class="kpi-value" id="completed-tasks">0</div>
                        <div class="kpi-subtitle">of <span id="total-tasks">0</span> total tasks</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">🔄</div>
                        <div class="kpi-label">Active Tasks</div>
                        <div class="kpi-value" id="ongoing-tasks">0</div>
                        <div class="kpi-subtitle">currently in progress</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">🎯</div>
                        <div class="kpi-label">Next Milestone</div>
                        <div class="kpi-value" style="font-size: 1.8em; line-height: 1.2;" id="next-milestone">Requirements Analysis</div>
                        <div class="kpi-subtitle">Phase 1 - Analysis</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Plan Tab -->
        <div id="project-tab" class="tab-content">
            <div id="project-warning" class="warning-message">
                ⚠️ Please select a project and complete the Client Setup first to access the project plan.
            </div>
            
            <div id="project-content" style="display: none;">
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <div class="table-header">
                        <h2>📋 Detailed Project Plan</h2>
                        <div class="client-info" id="client-display">No project selected</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 350px">Task</th>
                                <th style="width: 150px">Status</th>
                                <th style="width: 200px">Responsible</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="project-body">
                            <tr>
                                <td colspan="4" class="loading">Select a project to view tasks...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel Tab -->
        <div id="admin-tab" class="tab-content">
            <div class="admin-panel">
                <h2>👥 Admin Panel - Bruger Administration</h2>
                <p style="margin-bottom: 20px; color: #666;">Administrer brugere og deres roller i systemet.</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="loadAllUsers()">🔄 Opdater Liste</button>
                </div>
                
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Rolle</th>
                            <th>Oprettet</th>
                            <th>Handlinger</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>📊 Rolle Oversigt</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;"><span class="role-badge role-super_admin">Super Admin</span> - Fuld kontrol, kan ændre roller</li>
                        <li style="margin: 10px 0;"><span class="role-badge role-admin">Admin</span> - Kan administrere projekter og brugere</li>
                        <li style="margin: 10px 0;"><span class="role-badge role-project_manager">Project Manager</span> - Kan redigere alle projekter</li>
                        <li style="margin: 10px 0;"><span class="role-badge role-team_lead">Team Lead</span> - Kan se alle projekter</li>
                        <li style="margin: 10px 0;"><span class="role-badge role-user">User</span> - Kun egne projekter</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR VALUES
        const supabaseUrl = 'https://swlnojbzlfosjdtqswjd.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bG5vamJ6bGZvc2pkdHFzd2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDUzNzIsImV4cCI6MjA3MjkyMTM3Mn0.weAmKGGMeUaerNwyAoz6dpFufK0Fz1YbrdaUzsKiYk8';
        
        let supabase = null;
        let currentUser = null;
        let currentUserRole = 'user'; // Default role
        let currentProjectId = null;
        let currentProjectData = null;
        
        // Role definitions with permissions
        const rolePermissions = {
            'super_admin': {
                name: 'Super Admin',
                color: '#ff0000',
                canViewAllProjects: true,
                canEditAllProjects: true,
                canDeleteProjects: true,
                canManageUsers: true,
                canChangeRoles: true,
                canDeleteUsers: true,
                canExportAll: true
            },
            'admin': {
                name: 'Admin',
                color: '#ff4500',
                canViewAllProjects: true,
                canEditAllProjects: true,
                canDeleteProjects: true,
                canManageUsers: true,
                canChangeRoles: false,
                canDeleteUsers: false,
                canExportAll: true
            },
            'project_manager': {
                name: 'Project Manager',
                color: '#ffa500',
                canViewAllProjects: true,
                canEditAllProjects: true,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                canExportAll: true
            },
            'team_lead': {
                name: 'Team Lead',
                color: '#32cd32',
                canViewAllProjects: true,
                canEditAllProjects: false,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                canExportAll: false
            },
            'user': {
                name: 'User',
                color: '#808080',
                canViewAllProjects: false,
                canEditAllProjects: false,
                canDeleteProjects: false,
                canManageUsers: false,
                canChangeRoles: false,
                canDeleteUsers: false,
                canExportAll: false
            }
        };
        
        // Master template for new projects
        const masterTemplate = [
            {
                phase: "Phase 1: Analysis & Planning",
                tasks: [
                    {name: "1.1 Requirements Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Map dimension requirements and needs"},
                    {name: "1.2 System Mapping", status: "not-started", responsible: "Client", description: "Current setup in all systems"},
                    {name: "1.3 Gap Analysis", status: "not-started", responsible: "Scaleup Finance", description: "Identify change requirements"},
                    {name: "1.4 Technical Architecture", status: "not-started", responsible: "Scaleup Finance", description: "Design solution architecture"}
                ]
            },
            {
                phase: "Phase 2: e-conomic Configuration",
                tasks: [
                    {name: "2.1 Dimension Setup", status: "not-started", responsible: "Scaleup Finance", description: "Create dimensions in e-conomic"},
                    {name: "2.2 Chart of Accounts Adaptation", status: "not-started", responsible: "Scaleup Finance", description: "Update chart of accounts"},
                    {name: "2.3 Report Configuration", status: "not-started", responsible: "Scaleup Finance", description: "Customize standard reports"},
                    {name: "2.4 User Permissions", status: "not-started", responsible: "Client", description: "Setup user access rights"}
                ]
            },
            {
                phase: "Phase 3: Corpay Integration",
                tasks: [
                    {name: "3.1 Corpay Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Corpay"},
                    {name: "3.2 e-conomic Mapping", status: "not-started", responsible: "Scaleup Finance", description: "System mapping between platforms"},
                    {name: "3.3 Data Import Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test data transfer processes"},
                    {name: "3.4 Automation Rules", status: "not-started", responsible: "Scaleup Finance", description: "Setup automatic posting rules"}
                ]
            },
            {
                phase: "Phase 4: Pleo Integration",
                tasks: [
                    {name: "4.1 Pleo Setup", status: "not-started", responsible: "Client", description: "Configure dimensions in Pleo"},
                    {name: "4.2 Employee Training", status: "not-started", responsible: "Client", description: "Train employees on dimension usage"},
                    {name: "4.3 Approval Workflows", status: "not-started", responsible: "Client", description: "Setup approval processes"},
                    {name: "4.4 Integration Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test Pleo to e-conomic integration"}
                ]
            },
            {
                phase: "Phase 5: Testing & Validation",
                tasks: [
                    {name: "5.1 System Testing", status: "not-started", responsible: "Scaleup Finance", description: "Functional testing of all systems"},
                    {name: "5.2 User Acceptance Testing", status: "not-started", responsible: "Client", description: "Testing with end users"},
                    {name: "5.3 Report Validation", status: "not-started", responsible: "Scaleup Finance", description: "Verify report accuracy"},
                    {name: "5.4 Performance Testing", status: "not-started", responsible: "Scaleup Finance", description: "Test system performance"}
                ]
            },
            {
                phase: "Phase 6: Go-Live & Support",
                tasks: [
                    {name: "6.1 Production Implementation", status: "not-started", responsible: "Scaleup Finance", description: "Deploy to production environment"},
                    {name: "6.2 User Training", status: "not-started", responsible: "Scaleup Finance", description: "Train all users"},
                    {name: "6.3 Documentation", status: "not-started", responsible: "Scaleup Finance", description: "Create user manuals"},
                    {name: "6.4 Post-Implementation Support", status: "not-started", responsible: "Scaleup Finance", description: "Ongoing support first month"}
                ]
            }
        ];
        
        // Initialize Supabase
        try {
            if (supabaseUrl !== 'https://YOUR-PROJECT-REF.supabase.co') {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                checkAuth();
            } else {
                console.error('Please configure Supabase credentials');
                alert('Supabase er ikke konfigureret. Opdater credentials i HTML filen.');
            }
        } catch (error) {
            console.error('Supabase initialization error:', error);
        }
        
        // Authentication Functions
        async function checkAuth() {
            if (!supabase) return;
            
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                await loadUserRole();
                showDashboard();
            } else {
                showLoginScreen();
            }
        }
        
        // Load user role
        async function loadUserRole() {
            if (!supabase || !currentUser) return;
            
            try {
                // First check if users table exists and has role column
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userData && userData.role) {
                    currentUserRole = userData.role;
                } else {
                    // If no role found, set default based on if they're the first user
                    const { data: allUsers } = await supabase
                        .from('users')
                        .select('id');
                    
                    if (!allUsers || allUsers.length <= 1) {
                        // First user becomes super_admin
                        currentUserRole = 'super_admin';
                        await supabase
                            .from('users')
                            .upsert({
                                id: currentUser.id,
                                email: currentUser.email,
                                role: 'super_admin'
                            });
                    } else {
                        currentUserRole = 'user';
                    }
                }
            } catch (error) {
                console.log('Role loading error, using default:', error);
                currentUserRole = 'user';
            }
            
            updateUIBasedOnRole();
        }
        
        // Update UI based on role
        function updateUIBasedOnRole() {
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            
            // Update role badge
            const roleBadge = document.getElementById('current-user-role');
            if (roleBadge) {
                roleBadge.textContent = permissions.name;
                roleBadge.className = `role-badge role-${currentUserRole}`;
            }
            
            // Show/hide admin features
            const adminBtn = document.getElementById('admin-btn');
            const adminTab = document.getElementById('admin-tab');
            const shareBtn = document.getElementById('share-btn');
            
            if (permissions.canManageUsers) {
                if (adminBtn) adminBtn.style.display = 'inline-block';
                if (adminTab) adminTab.style.display = 'block';
            } else {
                if (adminBtn) adminBtn.style.display = 'none';
                if (adminTab) adminTab.style.display = 'none';
            }
            
            if (permissions.canEditAllProjects) {
                if (shareBtn) shareBtn.style.display = 'inline-block';
            } else {
                if (shareBtn) shareBtn.style.display = 'none';
            }
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            loadUserProjects();
        }
        
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            clearMessages();
        }
        
        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            clearMessages();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }
        
        function clearMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showError('Login fejlede: ' + error.message);
            } else {
                currentUser = data.user;
                await loadUserRole();
                showDashboard();
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const companyName = document.getElementById('company-name').value;
            
            if (!email || !password || !companyName) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            if (password.length < 6) {
                showError('Password skal være mindst 6 tegn');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        company_name: companyName
                    }
                }
            });
            
            if (error) {
                showError('Oprettelse fejlede: ' + error.message);
            } else {
                // Check if this is the first user
                const { data: allUsers } = await supabase
                    .from('users')
                    .select('id');
                
                const role = (!allUsers || allUsers.length === 0) ? 'super_admin' : 'user';
                
                // Create user record with role
                await supabase
                    .from('users')
                    .upsert({
                        id: data.user.id,
                        email: email,
                        role: role,
                        created_at: new Date().toISOString()
                    });
                
                showSuccess(`Konto oprettet! ${role === 'super_admin' ? 'Du er den første bruger og er nu Super Admin.' : ''} Du kan nu logge ind.`);
                setTimeout(() => showLogin(), 3000);
            }
        }
        
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                currentUser = null;
                currentUserRole = 'user';
                showLoginScreen();
            }
        }
        
        // Load user's projects based on role
        async function loadUserProjects() {
            if (!supabase || !currentUser) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            
            try {
                let query = supabase
                    .from('projects')
                    .select('project_id, client_data, user_id');
                
                // Only filter by user if they can't view all projects
                if (!permissions.canViewAllProjects) {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data: projects, error } = await query;

                if (error) throw error;

                const select = document.getElementById('project-select');
                if (select) {
                    select.innerHTML = '<option value="">Vælg eller opret et projekt...</option>';
                    
                    if (projects && projects.length > 0) {
                        projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            const clientName = project.client_data?.name || 'Unavngivet projekt';
                            const isOwner = project.user_id === currentUser.id;
                            option.textContent = clientName + (permissions.canViewAllProjects && !isOwner ? ' (Delt)' : '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error.message);
            }
        }
        
        // Load all users for admin panel
        async function loadAllUsers() {
            if (!supabase || !currentUser) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            if (!permissions.canManageUsers) return;
            
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('users-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        const userRole = user.role || 'user';
                        const isCurrentUser = user.id === currentUser.id;
                        
                        row.innerHTML = `
                            <td>${user.email}</td>
                            <td>
                                <span class="role-badge role-${userRole}">${rolePermissions[userRole]?.name || 'User'}</span>
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString('da-DK')}</td>
                            <td>
                                ${permissions.canChangeRoles && !isCurrentUser ? `
                                    <select class="role-select" onchange="updateUserRole('${user.id}', this.value)">
                                        <option value="user" ${userRole === 'user' ? 'selected' : ''}>User</option>
                                        <option value="team_lead" ${userRole === 'team_lead' ? 'selected' : ''}>Team Lead</option>
                                        <option value="project_manager" ${userRole === 'project_manager' ? 'selected' : ''}>Project Manager</option>
                                        <option value="admin" ${userRole === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="super_admin" ${userRole === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                                    </select>
                                ` : '<span style="color: #666;">-</span>'}
                                ${permissions.canDeleteUsers && !isCurrentUser ? `
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.9em;" onclick="deleteUser('${user.id}')">Slet</button>
                                ` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">Ingen brugere fundet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Update user role
        async function updateUserRole(userId, newRole) {
            if (!supabase) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            if (!permissions.canChangeRoles) {
                alert('Du har ikke tilladelse til at ændre roller');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('Rolle opdateret!');
                loadAllUsers();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Fejl ved opdatering af rolle');
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Er du sikker på at du vil slette denne bruger?')) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            if (!permissions.canDeleteUsers) {
                alert('Du har ikke tilladelse til at slette brugere');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('Bruger slettet!');
                loadAllUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Fejl ved sletning af bruger');
            }
        }
        
        // Handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Logo filen er for stor. Max størrelse er 2MB.');
                event.target.value = '';
                return;
            }
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Vælg venligst en gyldig billedfil (JPG, PNG, eller GIF)');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                // Show preview
                const preview = document.getElementById('logo-preview');
                const previewImg = document.getElementById('preview-image');
                const removeBtn = document.getElementById('remove-logo-btn');
                
                if (preview && previewImg) {
                    previewImg.src = dataUrl;
                    preview.style.display = 'block';
                }
                if (removeBtn) {
                    removeBtn.style.display = 'block';
                }
                
                // Update header logo
                updateHeaderLogo(dataUrl);
                
                // Save to current project
                if (currentProjectData) {
                    currentProjectData.client_data = currentProjectData.client_data || {};
                    currentProjectData.client_data.logo = dataUrl;
                    saveToSupabase();
                }
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                alert('Der opstod en fejl ved indlæsning af billedet.');
            };
            
            reader.readAsDataURL(file);
        }
        
        // Update header logo
        function updateHeaderLogo(logoUrl) {
            const headerLogo = document.getElementById('header-logo');
            const logoFallback = document.getElementById('logo-fallback');
            
            if (logoUrl && headerLogo) {
                headerLogo.src = logoUrl;
                headerLogo.style.display = 'block';
                if (logoFallback) logoFallback.style.display = 'none';
            } else {
                if (headerLogo) headerLogo.style.display = 'none';
                if (logoFallback) logoFallback.style.display = 'block';
            }
        }
        
        // Remove logo
        function removeLogo() {
            if (!confirm('Er du sikker på at du vil fjerne logoet?')) return;
            
            // Clear file input
            const fileInput = document.getElementById('logo-upload');
            if (fileInput) fileInput.value = '';
            
            // Hide preview
            const preview = document.getElementById('logo-preview');
            const removeBtn = document.getElementById('remove-logo-btn');
            if (preview) preview.style.display = 'none';
            if (removeBtn) removeBtn.style.display = 'none';
            
            // Reset header logo
            updateHeaderLogo(null);
            
            // Remove from project data
            if (currentProjectData && currentProjectData.client_data) {
                delete currentProjectData.client_data.logo;
                saveToSupabase();
            }
        }
        
        // Create new project
        async function createNewProject() {
            if (!currentUser) {
                alert('Du skal være logget ind for at oprette projekter');
                return;
            }
            
            const projectName = prompt('Indtast kundens firmanavn:');
            if (!projectName) return;
            
            const projectId = generateProjectId(projectName);
            currentProjectId = projectId;
            
            const newProject = {
                project_id: projectId,
                user_id: currentUser.id,
                client_data: {
                    name: projectName,
                    scaleupPM: '',
                    clientPM: '',
                    notes: ''
                },
                team_members: [],
                tasks: masterTemplate,
                is_public: false,
                created_at: new Date().toISOString(),
                last_updated: new Date().toISOString()
            };
            
            if (supabase) {
                try {
                    const { error } = await supabase
                        .from('projects')
                        .insert([newProject]);
                    
                    if (error) throw error;
                    
                    await loadUserProjects();
                    document.getElementById('project-select').value = projectId;
                    loadProject(projectId);
                } catch (error) {
                    console.error('Error creating project:', error.message);
                    alert('Fejl ved oprettelse af projekt: ' + error.message);
                }
            }
        }
        
        // Load project
        async function loadProject(projectId) {
            if (!projectId) {
                currentProjectId = null;
                resetUI();
                return;
            }
            
            currentProjectId = projectId;
            
            if (!supabase) return;
            
            try {
                const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
                
                let query = supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId);
                
                // If user can't view all projects, ensure they own it
                if (!permissions.canViewAllProjects) {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data: project, error } = await query.single();

                if (error) throw error;

                if (project) {
                    currentProjectData = project;
                    populateUIFromProject(project);
                    
                    // Load logo if exists
                    if (project.client_data?.logo) {
                        updateHeaderLogo(project.client_data.logo);
                        
                        // Show preview
                        const preview = document.getElementById('logo-preview');
                        const previewImg = document.getElementById('preview-image');
                        const removeBtn = document.getElementById('remove-logo-btn');
                        
                        if (preview && previewImg) {
                            previewImg.src = project.client_data.logo;
                            preview.style.display = 'block';
                        }
                        if (removeBtn) {
                            removeBtn.style.display = 'block';
                        }
                    } else {
                        updateHeaderLogo(null);
                    }
                }
            } catch (error) {
                console.error('Error loading project:', error.message);
                alert('Kunne ikke indlæse projekt. Du har muligvis ikke adgang.');
            }
        }
        
        // Populate UI from project data
        function populateUIFromProject(projectData) {
            const clientData = projectData.client_data || {};
            document.getElementById('client-name').value = clientData.name || '';
            document.getElementById('scaleup-pm').value = clientData.scaleupPM || '';
            document.getElementById('client-pm').value = clientData.clientPM || '';
            document.getElementById('project-notes').value = clientData.notes || '';
            
            checkSetup();
            populateTable();
            updateDashboard();
        }
        
        // Save to Supabase
        async function saveToSupabase() {
            if (!currentProjectId || !supabase || !currentUser) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            
            // Check if user can edit
            if (!permissions.canEditAllProjects && currentProjectData?.user_id !== currentUser.id) {
                console.log('No permission to edit this project');
                return;
            }
            
            const currentData = {
                client_data: {
                    name: document.getElementById('client-name').value.trim(),
                    scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                    clientPM: document.getElementById('client-pm').value.trim(),
                    notes: document.getElementById('project-notes').value.trim(),
                    logo: currentProjectData?.client_data?.logo // Preserve logo
                },
                tasks: currentProjectData?.tasks || masterTemplate,
                last_updated: new Date().toISOString()
            };
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .update(currentData)
                    .eq('project_id', currentProjectId);
                
                if (error) throw error;
            } catch (error) {
                console.error('Failed to save to Supabase:', error.message);
            }
            
            currentProjectData = { ...currentProjectData, ...currentData };
        }
        
        // Share project
        function shareProject() {
            if (!currentProjectId) {
                alert('Vælg et projekt først');
                return;
            }
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Projekt link kopieret til udklipsholder!');
                });
            } else {
                prompt('Del dette link:', shareUrl);
            }
        }
        
        // Generate project ID
        function generateProjectId(projectName) {
            const cleanName = projectName.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const timestamp = Date.now().toString().slice(-6);
            return `${cleanName}-${timestamp}`;
        }
        
        // Reset UI
        function resetUI() {
            document.getElementById('client-name').value = '';
            document.getElementById('scaleup-pm').value = '';
            document.getElementById('client-pm').value = '';
            document.getElementById('project-notes').value = '';
            updateHeaderLogo(null);
            checkSetup();
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Find and activate the nav button
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
                    (tabName === 'admin' && tab.id === 'admin-tab')) {
                    tab.classList.add('active');
                }
            });
            
            if (tabName === 'admin') {
                loadAllUsers();
            }
            
            checkSetup();
        }
        
        // Save setup
        function saveSetup() {
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                scaleupPM: document.getElementById('scaleup-pm').value.trim(),
                clientPM: document.getElementById('client-pm').value.trim(),
                notes: document.getElementById('project-notes').value.trim()
            };
            
            if (!clientData.name || !clientData.scaleupPM) {
                alert('Udfyld venligst kundenavn og Scaleup Finance PM');
                return;
            }
            
            saveToSupabase();
            switchTab('dashboard');
        }
        
        // Check setup
        function checkSetup() {
            const hasProject = currentProjectId !== null;
            const clientName = document.getElementById('client-name').value.trim();
            const scaleupPM = document.getElementById('scaleup-pm').value.trim();
            const hasSetup = hasProject && clientName && scaleupPM;
            
            const dashboardWarning = document.getElementById('dashboard-warning');
            const dashboardContent = document.getElementById('dashboard-content');
            const projectWarning = document.getElementById('project-warning');
            const projectContent = document.getElementById('project-content');
            
            if (hasSetup) {
                if (dashboardWarning) dashboardWarning.style.display = 'none';
                if (dashboardContent) dashboardContent.style.display = 'block';
                if (projectWarning) projectWarning.style.display = 'none';
                if (projectContent) projectContent.style.display = 'block';
                
                const clientDisplay = document.getElementById('client-display');
                if (clientDisplay) {
                    clientDisplay.textContent = `${clientName} | PM: ${scaleupPM}`;
                }
                
                populateTable();
                updateDashboard();
            } else {
                if (dashboardWarning) dashboardWarning.style.display = 'block';
                if (dashboardContent) dashboardContent.style.display = 'none';
                if (projectWarning) projectWarning.style.display = 'block';
                if (projectContent) projectContent.style.display = 'none';
            }
        }
        
        // Populate table
        function populateTable() {
            const tbody = document.getElementById('project-body');
            if (!tbody || !currentProjectData?.tasks) return;
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            const canEdit = permissions.canEditAllProjects || currentProjectData?.user_id === currentUser.id;
            
            tbody.innerHTML = '';
            
            currentProjectData.tasks.forEach(phase => {
                const phaseRow = document.createElement('tr');
                phaseRow.innerHTML = `<td colspan="4" style="background: #3a4a47; color: white; font-weight: bold; padding: 15px;">${phase.phase}</td>`;
                tbody.appendChild(phaseRow);
                
                phase.tasks.forEach(task => {
                    const taskRow = document.createElement('tr');
                    taskRow.innerHTML = `
                        <td>${task.name}</td>
                        <td>
                            <select class="status-select status-${task.status}" onchange="updateTaskStatus('${task.name}', this.value)" ${!canEdit ? 'disabled' : ''}>
                                <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>⏳ Not Started</option>
                                <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>🔄 In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>✅ Completed</option>
                            </select>
                        </td>
                        <td>
                            <select onchange="updateTaskResponsible('${task.name}', this.value)" style="width: 100%; padding: 6px;" ${!canEdit ? 'disabled' : ''}>
                                <option value="Scaleup Finance" ${task.responsible === 'Scaleup Finance' ? 'selected' : ''}>Scaleup Finance</option>
                                <option value="Client" ${task.responsible === 'Client' ? 'selected' : ''}>Client</option>
                            </select>
                        </td>
                        <td>${task.description}</td>
                    `;
                    tbody.appendChild(taskRow);
                });
            });
        }
        
        // Update dashboard
        function updateDashboard() {
            if (!currentProjectData?.tasks) return;
            
            let totalTasks = 0;
            let completedTasks = 0;
            let ongoingTasks = 0;
            
            currentProjectData.tasks.forEach(phase => {
                phase.tasks.forEach(task => {
                    totalTasks++;
                    if (task.status === 'completed') completedTasks++;
                    if (task.status === 'in-progress') ongoingTasks++;
                });
            });
            
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('overall-progress').textContent = progressPercent + '%';
            document.getElementById('overall-progress-bar').style.width = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('ongoing-tasks').textContent = ongoingTasks;
            
            // Find next milestone
            let nextMilestone = 'All tasks completed';
            for (const phase of currentProjectData.tasks) {
                for (const task of phase.tasks) {
                    if (task.status !== 'completed') {
                        nextMilestone = task.name.split(' ').slice(1).join(' ');
                        break;
                    }
                }
                if (nextMilestone !== 'All tasks completed') break;
            }
            document.getElementById('next-milestone').textContent = nextMilestone;
        }
        
        // Update task status
        async function updateTaskStatus(taskName, status) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.status = status;
                        if (event && event.target) {
                            event.target.className = `status-select status-${status}`;
                        }
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Update task responsible
        async function updateTaskResponsible(taskName, newResponsible) {
            if (!currentProjectData?.tasks) return;
            
            for (let phase of currentProjectData.tasks) {
                for (let task of phase.tasks) {
                    if (task.name === taskName) {
                        task.responsible = newResponsible;
                        updateDashboard();
                        await saveToSupabase();
                        break;
                    }
                }
            }
        }
        
        // Export project
        function exportProject() {
            if (!currentProjectData) {
                alert('Vælg et projekt først');
                return;
            }
            
            const permissions = rolePermissions[currentUserRole] || rolePermissions.user;
            
            // Check if user can export
            if (!permissions.canExportAll && currentProjectData?.user_id !== currentUser.id) {
                alert('Du har ikke tilladelse til at eksportere dette projekt');
                return;
            }
            
            // Ask if logo should be included
            let includelogo = false;
            if (currentProjectData.client_data?.logo) {
                includelogo = confirm('Vil du inkludere logoet i eksporten? (Dette vil gøre filen større)');
            }
            
            const exportData = {
                ...currentProjectData,
                exportedAt: new Date().toISOString(),
                exportedBy: currentUser.email
            };
            
            // Remove logo if not wanted
            if (!includelogo && exportData.client_data?.logo) {
                delete exportData.client_data.logo;
            }
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scaleup-project-${currentProjectId}.json`;
            a.click();
        }
        
        // Add auth state listener
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    loadUserRole().then(() => showDashboard());
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    currentUserRole = 'user';
                    showLoginScreen();
                }
            });
        }
        
        // Check for shared project in URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedProjectId = urlParams.get('project');
            
            if (sharedProjectId && currentUser) {
                setTimeout(() => {
                    document.getElementById('project-select').value = sharedProjectId;
                    loadProject(sharedProjectId);
                }, 1000);
            }
        });
    </script>
</body>
</html>