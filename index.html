<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scaleup Finance - Secure Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3a4a47, #2d3a36);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 74, 71, 0.3);
        }
        
        /* Share Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close-modal {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .close-modal:hover {
            opacity: 0.8;
        }
        
        .share-section {
            margin-bottom: 25px;
        }
        
        .share-section h3 {
            color: #3a4a47;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .share-link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .share-link-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: #f8f9fa;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .copy-link-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .copy-link-btn:hover {
            background: #218838;
        }
        
        .permission-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .permission-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .permission-info p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
        }
        
        .collaborators-list {
            margin-top: 20px;
        }
        
        .collaborator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .collaborator-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .collaborator-email {
            font-weight: 600;
            color: #333;
        }
        
        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .role-super_admin {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
        
        .role-owner {
            background: #3a4a47;
            color: white;
        }
        
        .role-admin {
            background: #dc3545;
            color: white;
        }
        
        .role-editor {
            background: #007bff;
            color: white;
        }
        
        .role-viewer {
            background: #6c757d;
            color: white;
        }
        
        .add-collaborator-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .add-email-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        
        .add-role-select {
            width: 150px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        
        .add-collaborator-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .add-collaborator-btn:hover {
            background: #0056b3;
        }
        
        /* Access Info Badge */
        .access-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 15px;
        }
        
        .access-badge.super_admin {
            background: linear-gradient(135deg, #FFD700, #FFA500) !important;
            color: #333 !important;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
            border: none;
        }
        
        .access-badge.owner {
            border-color: #3a4a47;
            color: #3a4a47;
        }
        
        .access-badge.admin {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .access-badge.editor {
            border-color: #007bff;
            color: #007bff;
        }
        
        .access-badge.viewer {
            border-color: #6c757d;
            color: #6c757d;
        }
        
        /* User Info Bar */
        .user-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            font-weight: 600;
            color: #3a4a47;
        }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, #3a4a47 0%, #2d3a36 100%);
            color: white; 
            padding: 50px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 30px;
        }
        
        .scaleup-logo {
            width: 100px; 
            height: 100px; 
            background: #ffffff; 
            border-radius: 15px; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            font-size: 48px;
            font-weight: 800;
            color: #3a4a47;
        }
        
        .company-name {
            font-size: 4em;
            font-weight: 700;
            color: white;
        }
        
        .header-description {
            font-size: 1.3em;
            opacity: 0.9;
            text-align: center;
        }
        
        /* Project Controls */
        .project-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            min-width: 250px;
        }
        
        .nav-tabs { display: flex; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .nav-tab { flex: 1; padding: 15px 25px; background: #f8f9fa; border: none; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; }
        .nav-tab.active { background: linear-gradient(135deg, #3a4a47, #2d3a36); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; transition: all 0.3s; }
        .btn-primary { background: #3a4a47; color: white; }
        .btn-primary:hover { background: #2d3a36; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <h1>Scaleup Finance</h1>
                <p>e-conomic Dimensions Dashboard</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2 style="margin-bottom: 20px;">Log ind</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button onclick="handleLogin()">Log ind</button>
                <div class="auth-toggle">
                    Ny bruger? <a href="#" onclick="showSignup(); return false;">Opret konto</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <h2 style="margin-bottom: 20px;">Opret konto</h2>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6 tegn)" required>
                <button onclick="handleSignup()">Opret konto</button>
                <div class="auth-toggle">
                    Har du allerede en konto? <a href="#" onclick="showLogin(); return false;">Log ind</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Del Projekt</h2>
                <button class="close-modal" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Share Link Section -->
                <div class="share-section">
                    <h3>🔗 Del med link</h3>
                    <div class="share-link-container">
                        <input type="text" id="share-link" class="share-link-input" readonly>
                        <button class="copy-link-btn" onclick="copyShareLink()">📋 Kopier</button>
                    </div>
                    
                    <select id="link-permission" class="permission-select" onchange="updateShareLink()">
                        <option value="viewer">Kun visning</option>
                        <option value="editor">Kan redigere</option>
                        <option value="admin">Administrator</option>
                    </select>
                    
                    <div class="permission-info">
                        <p id="permission-desc">Personer med dette link kan se projektet</p>
                    </div>
                </div>

                <!-- Collaborators Section -->
                <div class="share-section">
                    <h3>👥 Projektmedlemmer</h3>
                    <div id="collaborators-list" class="collaborators-list">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div class="add-collaborator-form">
                        <input type="email" id="new-collaborator-email" class="add-email-input" placeholder="Email adresse">
                        <select id="new-collaborator-role" class="add-role-select">
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="add-collaborator-btn" onclick="addCollaborator()">Tilføj</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until logged in) -->
    <div id="main-dashboard" class="container" style="display: none;">
        
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info">
                <span>Logget ind som:</span>
                <span class="user-email" id="current-user-email">-</span>
                <span id="user-role-badge" class="access-badge"></span>
            </div>
            <button class="btn btn-danger" onclick="handleLogout()">Log ud</button>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="scaleup-logo">8</div>
                <div class="company-name">Scaleup Finance</div>
            </div>
            <div class="header-description">e-conomic Dimensions Implementation Dashboard</div>
        </div>

        <!-- Project Controls -->
        <div class="project-controls">
            <div class="project-info">
                <label style="font-weight: 600; color: #495057;">Current Project:</label>
                <select id="project-select" class="project-select" onchange="loadProject(this.value)">
                    <option value="">Vælg eller opret et projekt...</option>
                </select>
            </div>
            <div>
                <button class="btn btn-info" onclick="openShareModal()">🔗 Del Projekt</button>
                <button class="btn btn-success" onclick="createNewProject()">➕ Nyt Projekt</button>
                <button class="btn btn-secondary" onclick="exportProject()">💾 Export</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('setup')">🔧 Client Setup</button>
            <button class="nav-tab" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="switchTab('project')">📋 Project Plan</button>
        </div>

        <!-- Content will be added here -->
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR VALUES
        const supabaseUrl = 'https://swlnojbzlfosjdtqswjd.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bG5vamJ6bGZvc2pkdHFzd2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNDUzNzIsImV4cCI6MjA3MjkyMTM3Mn0.weAmKGGMeUaerNwyAoz6dpFufK0Fz1YbrdaUzsKiYk8';
        
        let supabase = null;
        let currentUser = null;
        let currentProjectId = null;
        let currentProjectData = null;
        let currentUserRole = null;
        
        // Initialize Supabase
        try {
            if (supabaseUrl !== 'https://YOUR-PROJECT-REF.supabase.co') {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                checkAuth();
            } else {
                console.error('Please configure Supabase credentials');
                alert('Supabase er ikke konfigureret. Opdater credentials i HTML filen.');
            }
        } catch (error) {
            console.error('Supabase initialization error:', error);
        }
        
        // Check if user came from share link
        function checkShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            const permission = urlParams.get('permission') || 'viewer';
            
            if (shareId) {
                // Store share link info in session storage
                sessionStorage.setItem('shareId', shareId);
                sessionStorage.setItem('sharePermission', permission);
                
                // If user is logged in, grant access
                if (currentUser) {
                    grantAccessFromShareLink(shareId, permission);
                }
            }
        }
        
        // Grant access from share link
        async function grantAccessFromShareLink(shareId, permission) {
            if (!supabase || !currentUser) return;
            
            try {
                // First, find the project with this share ID
                const { data: project, error: projectError } = await supabase
                    .from('projects')
                    .select('project_id')
                    .eq('share_id', shareId)
                    .single();
                
                if (projectError) throw projectError;
                
                // Check if user already has access
                const { data: existingAccess, error: accessError } = await supabase
                    .from('project_access')
                    .select('role')
                    .eq('project_id', project.project_id)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!existingAccess) {
                    // Grant new access
                    const { error: insertError } = await supabase
                        .from('project_access')
                        .insert({
                            project_id: project.project_id,
                            user_id: currentUser.id,
                            user_email: currentUser.email,
                            role: permission,
                            granted_by: 'share_link',
                            created_at: new Date().toISOString()
                        });
                    
                    if (insertError) throw insertError;
                    
                    alert(`Du har nu ${permission} adgang til projektet!`);
                }
                
                // Clear share link from URL and session
                window.history.replaceState({}, document.title, window.location.pathname);
                sessionStorage.removeItem('shareId');
                sessionStorage.removeItem('sharePermission');
                
                // Load the project
                await loadUserProjects();
                loadProject(project.project_id);
                
            } catch (error) {
                console.error('Error granting access from share link:', error);
            }
        }
        
        // Generate unique share ID
        function generateShareId() {
            return 'share_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }
        
        // Open share modal
        async function openShareModal() {
            if (!currentProjectId) {
                alert('Vælg venligst et projekt først');
                return;
            }
            
            document.getElementById('share-modal').style.display = 'block';
            
            // Generate share link
            updateShareLink();
            
            // Load collaborators
            await loadCollaborators();
        }
        
        // Close share modal
        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }
        
        // Update share link based on permission
        async function updateShareLink() {
            if (!currentProjectData) return;
            
            const permission = document.getElementById('link-permission').value;
            
            // Ensure project has share_id
            if (!currentProjectData.share_id) {
                currentProjectData.share_id = generateShareId();
                
                // Update in database
                if (supabase) {
                    await supabase
                        .from('projects')
                        .update({ share_id: currentProjectData.share_id })
                        .eq('project_id', currentProjectId);
                }
            }
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?share=${currentProjectData.share_id}&permission=${permission}`;
            document.getElementById('share-link').value = shareUrl;
            
            // Update permission description
            const descriptions = {
                'viewer': 'Personer med dette link kan se projektet',
                'editor': 'Personer med dette link kan redigere projektet',
                'admin': 'Personer med dette link får administrator rettigheder'
            };
            
            document.getElementById('permission-desc').textContent = descriptions[permission];
        }
        
        // Copy share link to clipboard
        function copyShareLink() {
            const linkInput = document.getElementById('share-link');
            linkInput.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✓ Kopieret!';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }
        
        // Load collaborators
        async function loadCollaborators() {
            if (!supabase || !currentProjectId) return;
            
            try {
                const { data: collaborators, error } = await supabase
                    .from('project_access')
                    .select('*')
                    .eq('project_id', currentProjectId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const listDiv = document.getElementById('collaborators-list');
                listDiv.innerHTML = '';
                
                // Add super admins to the list (they always have access)
                if (currentProjectId !== 'GLOBAL_ADMIN') {
                    SUPER_ADMINS.forEach(adminEmail => {
                        const item = document.createElement('div');
                        item.className = 'collaborator-item';
                        item.innerHTML = `
                            <div class="collaborator-info">
                                <span class="collaborator-email">${adminEmail}</span>
                                <span class="role-badge role-super_admin">🌟 SUPER ADMIN</span>
                            </div>
                        `;
                        listDiv.appendChild(item);
                    });
                }
                
                // Add regular collaborators
                collaborators.forEach(collab => {
                    // Skip if it's a super admin (already shown above)
                    if (SUPER_ADMINS.includes(collab.user_email)) return;
                    
                    const item = document.createElement('div');
                    item.className = 'collaborator-item';
                    
                    const isOwner = collab.role === 'owner';
                    const canRemove = currentUserRole === 'owner' || currentUserRole === 'admin' || currentUserRole === 'super_admin';
                    
                    item.innerHTML = `
                        <div class="collaborator-info">
                            <span class="collaborator-email">${collab.user_email}</span>
                            <span class="role-badge role-${collab.role}">${collab.role.toUpperCase()}</span>
                        </div>
                        ${!isOwner && canRemove ? 
                            `<button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9em;" 
                                onclick="removeCollaborator('${collab.user_id}')">Fjern</button>` 
                            : ''}
                    `;
                    
                    listDiv.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error loading collaborators:', error);
            }
        }
        
        // Add collaborator
        async function addCollaborator() {
            const email = document.getElementById('new-collaborator-email').value.trim();
            const role = document.getElementById('new-collaborator-role').value;
            
            if (!email) {
                alert('Indtast venligst en email adresse');
                return;
            }
            
            if (!supabase || !currentProjectId) return;
            
            try {
                // Find user by email
                const { data: userData, error: userError } = await supabase
                    .from('auth.users')
                    .select('id')
                    .eq('email', email)
                    .single();
                
                let userId = userData?.id;
                
                // If user doesn't exist, they'll get access when they sign up with this email
                if (!userId) {
                    userId = 'pending_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                }
                
                // Add access record
                const { error } = await supabase
                    .from('project_access')
                    .insert({
                        project_id: currentProjectId,
                        user_id: userId,
                        user_email: email,
                        role: role,
                        granted_by: currentUser.id,
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Clear form and reload
                document.getElementById('new-collaborator-email').value = '';
                await loadCollaborators();
                
                alert(`${email} er tilføjet som ${role}`);
                
            } catch (error) {
                console.error('Error adding collaborator:', error);
                alert('Kunne ikke tilføje bruger: ' + error.message);
            }
        }
        
        // Remove collaborator
        async function removeCollaborator(userId) {
            if (!confirm('Er du sikker på at du vil fjerne denne bruger?')) return;
            
            if (!supabase || !currentProjectId) return;
            
            try {
                const { error } = await supabase
                    .from('project_access')
                    .delete()
                    .eq('project_id', currentProjectId)
                    .eq('user_id', userId);
                
                if (error) throw error;
                
                await loadCollaborators();
                
            } catch (error) {
                console.error('Error removing collaborator:', error);
                alert('Kunne ikke fjerne bruger: ' + error.message);
            }
        }
        
        // Super admin emails
        const SUPER_ADMINS = ['mma@scaleup.finance', 'jbo@scaleup.finance'];
        
        // Check if user is super admin
        function isSuperAdmin() {
            return currentUser && SUPER_ADMINS.includes(currentUser.email);
        }
        
        // Check user's role for current project
        async function checkUserRole(projectId) {
            if (!supabase || !currentUser) return 'viewer';
            
            // Super admins always have full access
            if (isSuperAdmin()) {
                currentUserRole = 'super_admin';
                return 'super_admin';
            }
            
            try {
                // Check if user is owner
                const { data: project, error: projectError } = await supabase
                    .from('projects')
                    .select('user_id')
                    .eq('project_id', projectId)
                    .single();
                
                if (project && project.user_id === currentUser.id) {
                    currentUserRole = 'owner';
                    return 'owner';
                }
                
                // Check access table
                const { data: access, error: accessError } = await supabase
                    .from('project_access')
                    .select('role')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (access) {
                    currentUserRole = access.role;
                    return access.role;
                }
                
                currentUserRole = 'viewer';
                return 'viewer';
                
            } catch (error) {
                console.error('Error checking user role:', error);
                return 'viewer';
            }
        }
        
        // Update UI based on user role
        function updateUIForRole(role) {
            const badge = document.getElementById('user-role-badge');
            if (badge) {
                badge.className = `access-badge ${role}`;
                if (role === 'super_admin') {
                    badge.textContent = '🌟 SUPER ADMIN';
                    badge.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
                    badge.style.color = '#333';
                    badge.style.fontWeight = 'bold';
                } else {
                    badge.textContent = role.toUpperCase();
                }
            }
            
            // Enable/disable editing based on role
            const canEdit = role === 'owner' || role === 'admin' || role === 'editor' || role === 'super_admin';
            
            // Super admins can always edit everything
            if (role !== 'super_admin') {
                // Disable/enable form inputs for regular users
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    if (!element.id.includes('login') && !element.id.includes('share') && 
                        !element.id.includes('collaborator') && element.id !== 'project-select') {
                        element.disabled = !canEdit;
                    }
                });
            }
            
            // Show/hide action buttons based on role
            const canManage = role === 'owner' || role === 'admin' || role === 'super_admin';
            
            // Show super admin indicator in header if applicable
            if (role === 'super_admin') {
                const header = document.querySelector('.header-description');
                if (header && !header.textContent.includes('Super Admin')) {
                    header.innerHTML += '<br><span style="color: #FFD700; font-size: 0.9em;">⚡ Super Admin Mode</span>';
                }
            }
        }
        
        // Authentication Functions
        async function checkAuth() {
            if (!supabase) return;
            
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                showDashboard();
                checkShareLink(); // Check if user came from share link
            } else {
                showLoginScreen();
            }
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-dashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
                
                // Show super admin badge immediately if user is super admin
                if (isSuperAdmin()) {
                    const badge = document.getElementById('user-role-badge');
                    if (badge) {
                        badge.className = 'access-badge super_admin';
                        badge.textContent = '🌟 SUPER ADMIN';
                        badge.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
                        badge.style.color = '#333';
                        badge.style.fontWeight = 'bold';
                        badge.style.display = 'inline-flex';
                    }
                }
            }
            loadUserProjects();
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showError('Login fejlede: ' + error.message);
            } else {
                currentUser = data.user;
                showDashboard();
                checkShareLink(); // Check for share link after login
            }
        }
        
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            clearMessages();
        }
        
        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            clearMessages();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 5000);
        }
        
        function clearMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!email || !password) {
                showError('Udfyld venligst alle felter');
                return;
            }
            
            if (password.length < 6) {
                showError('Password skal være mindst 6 tegn');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (error) {
                showError('Oprettelse fejlede: ' + error.message);
            } else {
                showSuccess('Konto oprettet! Check din email for at bekræfte.');
                setTimeout(() => showLogin(), 3000);
            }
        }
        
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                currentUser = null;
                currentUserRole = null;
                showLoginScreen();
            }
        }
        
        // Load user's projects (including shared ones)
        async function loadUserProjects() {
            if (!supabase || !currentUser) return;
            
            try {
                let allProjects = [];
                let ownedProjects = [];
                let sharedProjects = [];
                
                // Super admins can see ALL projects
                if (isSuperAdmin()) {
                    const { data: allData, error } = await supabase
                        .from('projects')
                        .select('project_id, client_data, user_id')
                        .order('created_at', { ascending: false });
                    
                    if (allData) {
                        allProjects = allData;
                        // Separate owned vs others
                        ownedProjects = allData.filter(p => p.user_id === currentUser.id);
                        sharedProjects = allData.filter(p => p.user_id !== currentUser.id);
                    }
                } else {
                    // Regular users: get owned projects
                    const { data: owned, error: ownError } = await supabase
                        .from('projects')
                        .select('project_id, client_data')
                        .eq('user_id', currentUser.id);
                    
                    ownedProjects = owned || [];
                    
                    // Get shared projects
                    const { data: sharedAccess, error: sharedError } = await supabase
                        .from('project_access')
                        .select('project_id, role')
                        .eq('user_id', currentUser.id);
                    
                    if (sharedAccess && sharedAccess.length > 0) {
                        const sharedIds = sharedAccess.map(a => a.project_id);
                        const { data: sharedData, error } = await supabase
                            .from('projects')
                            .select('project_id, client_data')
                            .in('project_id', sharedIds);
                        
                        sharedProjects = sharedData || [];
                    }
                }
                
                const select = document.getElementById('project-select');
                if (select) {
                    select.innerHTML = '<option value="">Vælg eller opret et projekt...</option>';
                    
                    // Super admin sees all projects
                    if (isSuperAdmin() && allProjects.length > 0) {
                        const allGroup = document.createElement('optgroup');
                        allGroup.label = '🌟 Alle Projekter (Super Admin)';
                        
                        allProjects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            option.textContent = project.client_data?.name || 'Unavngivet projekt';
                            allGroup.appendChild(option);
                        });
                        
                        select.appendChild(allGroup);
                    } else {
                        // Regular view for non-super admins
                        // Add owned projects
                        if (ownedProjects && ownedProjects.length > 0) {
                            const ownedGroup = document.createElement('optgroup');
                            ownedGroup.label = 'Mine projekter';
                            
                            ownedProjects.forEach(project => {
                                const option = document.createElement('option');
                                option.value = project.project_id;
                                option.textContent = project.client_data?.name || 'Unavngivet projekt';
                                ownedGroup.appendChild(option);
                            });
                            
                            select.appendChild(ownedGroup);
                        }
                        
                        // Add shared projects
                        if (sharedProjects.length > 0) {
                            const sharedGroup = document.createElement('optgroup');
                            sharedGroup.label = 'Delte projekter';
                            
                            sharedProjects.forEach(project => {
                                const option = document.createElement('option');
                                option.value = project.project_id;
                                option.textContent = `${project.client_data?.name || 'Unavngivet'}`;
                                sharedGroup.appendChild(option);
                            });
                            
                            select.appendChild(sharedGroup);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error.message);
            }
        }
        
        // Load project
        async function loadProject(projectId) {
            if (!projectId) {
                currentProjectId = null;
                currentUserRole = null;
                return;
            }
            
            currentProjectId = projectId;
            
            // Check user role for this project
            const role = await checkUserRole(projectId);
            updateUIForRole(role);
            
            if (!supabase) return;
            
            try {
                // Super admins and owners can access any project
                const canAccessAnyProject = isSuperAdmin();
                
                let query = supabase
                    .from('projects')
                    .select('*')
                    .eq('project_id', projectId);
                
                // If not super admin, add user filter
                if (!canAccessAnyProject) {
                    // This will be checked via checkUserRole instead
                }
                
                const { data: project, error } = await query.single();

                if (error) throw error;

                if (project) {
                    currentProjectData = project;
                    // Additional UI updates would go here
                    console.log('Loaded project:', project.client_data?.name, 'Role:', role);
                }
            } catch (error) {
                console.error('Error loading project:', error.message);
            }
        }
        
        // Create new project
        async function createNewProject() {
            if (!currentUser) {
                alert('Du skal være logget ind for at oprette projekter');
                return;
            }
            
            const projectName = prompt('Indtast kundens firmanavn:');
            if (!projectName) return;
            
            const projectId = 'proj_' + Math.random().toString(36).substr(2, 9);
            const shareId = generateShareId();
            
            currentProjectId = projectId;
            
            const newProject = {
                project_id: projectId,
                share_id: shareId,
                user_id: currentUser.id,
                client_data: {
                    name: projectName,
                    scaleupPM: '',
                    clientPM: '',
                    notes: ''
                },
                team_members: [],
                tasks: [],
                is_public: false,
                created_at: new Date().toISOString(),
                last_updated: new Date().toISOString()
            };
            
            if (supabase) {
                try {
                    const { error } = await supabase
                        .from('projects')
                        .insert([newProject]);
                    
                    if (error) throw error;
                    
                    // Also create owner access record
                    await supabase
                        .from('project_access')
                        .insert({
                            project_id: projectId,
                            user_id: currentUser.id,
                            user_email: currentUser.email,
                            role: 'owner',
                            granted_by: currentUser.id,
                            created_at: new Date().toISOString()
                        });
                    
                    await loadUserProjects();
                    document.getElementById('project-select').value = projectId;
                    loadProject(projectId);
                    
                } catch (error) {
                    console.error('Error creating project:', error.message);
                    alert('Fejl ved oprettelse af projekt: ' + error.message);
                }
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab')?.classList.add('active');
            event.target.classList.add('active');
        }
        
        function exportProject() {
            if (!currentProjectData) {
                alert('Vælg venligst et projekt først');
                return;
            }
            
            const exportData = {
                ...currentProjectData,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scaleup-project-${currentProjectId}.json`;
            a.click();
        }
        
        // Add auth state listener
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    showDashboard();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    currentUserRole = null;
                    showLoginScreen();
                }
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('share-modal')) {
                closeShareModal();
            }
        }
    </script>
</body>
</html>